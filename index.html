<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>è¿‘ç°ä»£å² - æ™ºèƒ½å¤ä¹ ç³»ç»Ÿ V16.1 (è‡ªåŠ¨åŒæ­¥ä¿®å¤ç‰ˆ)</title>
    <style>
      :root {
        /* äº®è‰²æ¨¡å¼å˜é‡ */
        --primary: #4f46e5;
        --primary-light: #eef2ff;
        --primary-hover: #4338ca;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --text-main: #1f2937;
        --text-sub: #64748b;
        --bg-body: #f8fafc;
        --bg-card: #ffffff;
        --bg-sidebar: #ffffff;
        --border-color: #e2e8f0;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --sidebar-width: 280px;
        --safe-bottom: env(safe-area-inset-bottom, 20px);
      }

      /* æ·±è‰²æ¨¡å¼å˜é‡ */
      body.dark-mode {
        --primary: #6366f1;
        --primary-light: #312e81;
        --primary-hover: #818cf8;
        --success: #34d399;
        --warning: #fbbf24;
        --error: #f87171;
        --text-main: #f1f5f9;
        --text-sub: #94a3b8;
        --bg-body: #0f172a;
        --bg-card: #1e293b;
        --bg-sidebar: #1e293b;
        --border-color: #334155;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, "PingFang SC", sans-serif;
        background-color: var(--bg-body);
        color: var(--text-main);
        height: 100vh;
        display: flex;
        overflow: hidden;
        transition: background-color 0.3s, color 0.3s;
      }

      /* === ä¾§è¾¹æ  === */
      .sidebar {
        width: var(--sidebar-width);
        background: var(--bg-sidebar);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        z-index: 50;
        transition: transform 0.3s, background-color 0.3s, border-color 0.3s;
        flex-shrink: 0;
      }

      .sidebar-header {
        padding: 20px;
        background: var(--bg-sidebar);
        border-bottom: 1px solid var(--border-color);
      }

      .app-brand {
        font-size: 1.2rem;
        font-weight: 800;
        color: var(--primary);
        text-align: center;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      
      /* å€’è®¡æ—¶æ ·å¼ */
      .countdown-box {
        background: linear-gradient(135deg, #4f46e5, #ec4899);
        color: white;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 15px;
        font-size: 0.9rem;
        box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        cursor: pointer;
      }
      .countdown-num {
        font-size: 1.4rem;
        font-weight: 800;
        margin: 0 4px;
        text-decoration: underline;
        text-underline-offset: 4px;
      }

      .mod-tabs {
        display: flex;
        background: var(--bg-body);
        padding: 4px;
        border-radius: 8px;
      }
      
      .mode-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 5px;
      }
      .mod-row {
        display: flex;
        background: var(--bg-body);
        padding: 3px;
        border-radius: 8px;
        gap: 4px;
      }
      .mod-tab {
        flex: 1;
        border: none;
        background: none;
        padding: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-sub);
        cursor: pointer;
        border-radius: 6px;
        transition: 0.2s;
        white-space: nowrap;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }
      .mod-tab.active {
        background: var(--bg-card);
        color: var(--primary);
        box-shadow: var(--shadow-sm);
      }
      /* ç‰¹æ®Šæ¨¡å¼æŒ‰é’® */
      .special-btn { color: var(--error); }
      .special-btn.active { background: var(--error); color: white; }
      
      .random-btn { color: var(--success); }
      .random-btn.active { background: var(--success); color: white; }
      
      .star-tab-btn { color: #f59e0b; }
      .star-tab-btn.active { background: #f59e0b; color: white; }

      .mock-btn { color: #8b5cf6; }
      .mock-btn.active { background: #8b5cf6; color: white; }

      .chapter-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .chapter-item {
        padding: 12px;
        margin-bottom: 6px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        flex-direction: column; /* æ”¹ä¸ºçºµå‘å¸ƒå±€ä»¥å®¹çº³è¿›åº¦æ¡ */
        justify-content: center;
        color: var(--text-sub);
        transition: 0.2s;
        border: 1px solid transparent;
      }
      .chapter-item:hover {
        background: var(--primary-light);
      }
      .chapter-item.active {
        background: var(--primary-light);
        color: var(--primary);
        border-color: var(--primary); /* å¢å¼ºé€‰ä¸­æ„Ÿ */
        font-weight: 600;
      }

      .chap-row-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        margin-bottom: 4px;
      }

      .progress-track {
        height: 4px;
        width: 100%;
        background: var(--border-color);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 2px;
      }
      .progress-fill {
        height: 100%;
        background: var(--success);
        width: 0%;
        transition: width 0.5s ease;
      }

      .badge-pill {
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 10px;
        background: var(--border-color);
        color: var(--text-sub);
      }
      .chapter-item.active .badge-pill {
        background: var(--bg-card);
        color: var(--primary);
      }

      /* === ä¸»å†…å®¹åŒº === */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
        background: var(--bg-body);
        position: relative;
        min-width: 0;
        transition: background-color 0.3s;
      }

      /* é¡¶éƒ¨å¯¼èˆª */
      .top-nav {
        background: var(--bg-card);
        padding: 10px 15px;
        box-shadow: var(--shadow-sm);
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 20;
        border-bottom: 1px solid var(--border-color);
        position: relative;
      }
      
      /* æ¨¡æ‹Ÿè€ƒè¯•ä¸“ç”¨è®¡æ—¶æ¡ */
      .exam-timer-bar {
        display: none;
        background: #1e293b;
        color: white;
        padding: 8px 15px;
        justify-content: space-between;
        align-items: center;
        font-variant-numeric: tabular-nums;
        font-weight: bold;
      }
      .exam-timer-bar.active { display: flex; }

      .nav-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .menu-toggle {
        font-size: 1.5rem;
        background: none;
        border: none;
        color: var(--text-sub);
        cursor: pointer;
        display: none;
        margin-right: 10px;
      }

      .nav-title {
        font-weight: 700;
        font-size: 1rem;
        color: var(--text-main);
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }

      .jump-box {
        padding: 6px 8px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.85rem;
        color: var(--text-main);
        outline: none;
        background: var(--bg-body);
        max-width: 120px;
      }

      /* ç­›é€‰å™¨ */
      .filter-scroll {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 2px;
        scrollbar-width: none;
      }
      .filter-scroll::-webkit-scrollbar { display: none; }

      .filter-chip {
        padding: 5px 12px;
        border-radius: 20px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        color: var(--text-sub);
        font-size: 0.8rem;
        white-space: nowrap;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .filter-chip.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
      }

      /* å†…å®¹æ»šåŠ¨åŒº */
      .content-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        justify-content: center;
      }

      .card {
        background: var(--bg-card);
        border-radius: 16px;
        box-shadow: var(--shadow-md);
        padding: 25px;
        width: 100%;
        max-width: 800px;
        height: fit-content;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
        border: 1px solid var(--border-color);
        transition: background-color 0.3s, border-color 0.3s;
      }

      .card.knowledge-mode {
        border-left: 5px solid var(--warning);
        background: var(--bg-card); /* ä¿æŒå¡ç‰‡èƒŒæ™¯ */
      }
      .dark-mode .card.knowledge-mode {
        background: #2a2210; /* æ·±è‰²æ¨¡å¼ä¸‹çš„å¾®é»„è‰² */
      }
      
      .card.material-mode { border-left: 5px solid #8b5cf6; }
      .card.wrong-mode { border-left: 5px solid var(--error); }
      .card.fav-mode { border-left: 5px solid #f59e0b; }

      .q-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        align-items: center;
      }

      .q-type {
        font-size: 0.75rem;
        padding: 3px 8px;
        border-radius: 6px;
        font-weight: 700;
        background: var(--bg-body);
        color: var(--text-sub);
        border: 1px solid var(--border-color);
      }
      
      .star-icon {
        font-size: 1.5rem;
        cursor: pointer;
        color: #cbd5e1;
        transition: 0.2s;
        margin-left: 10px;
      }
      .star-icon.active {
        color: #f59e0b;
        transform: scale(1.2);
      }

      .q-content {
        font-size: 1.15rem;
        line-height: 1.7;
        color: var(--text-main);
        margin-bottom: 25px;
        white-space: pre-wrap;
      }

      /* é€‰é¡¹ */
      .opts-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .opt-row {
        display: flex;
        padding: 15px;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        cursor: pointer;
        background: var(--bg-card);
        transition: 0.15s;
        align-items: flex-start;
        color: var(--text-main);
      }
      .opt-row:hover { border-color: #cbd5e1; }
      
      .opt-row.selected {
        border-color: var(--primary);
        background: var(--primary-light);
      }
      .opt-row.correct {
        border-color: var(--success);
        background: rgba(16, 185, 129, 0.1); /* é€æ˜æ˜¾è‰²é€‚é…æš—é»‘æ¨¡å¼ */
      }
      .opt-row.wrong {
        border-color: var(--error);
        background: rgba(239, 68, 68, 0.1);
      }
      .opt-row.missed {
        border-color: var(--warning);
        background: rgba(245, 158, 11, 0.1);
        border-style: dashed;
      }

      .opt-idx {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--bg-body);
        color: var(--text-sub);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        margin-right: 12px;
        flex-shrink: 0;
        border: 1px solid var(--border-color);
      }
      .opt-row.selected .opt-idx { background: var(--primary); color: white; border-color: var(--primary); }
      .opt-row.correct .opt-idx { background: var(--success); color: white; border-color: var(--success); }
      .opt-row.wrong .opt-idx { background: var(--error); color: white; border-color: var(--error); }
      .opt-row.missed .opt-idx { background: var(--warning); color: white; border-color: var(--warning); }

      /* ç­”æ¡ˆä¸è§£æ */
      .answer-section {
        margin-top: 25px;
        padding: 20px;
        background: var(--bg-body);
        border-radius: 12px;
        display: none;
        border: 1px solid var(--border-color);
      }
      .answer-section.show {
        display: block;
        animation: slideDown 0.3s;
      }
      
      .status-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: bold;
        margin-bottom: 15px;
      }
      .status-correct { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }
      .status-partial { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid var(--warning); }
      .status-wrong { background: rgba(239, 68, 68, 0.2); color: var(--error); border: 1px solid var(--error); }

      /* AI ç»“æœ */
      .ai-result {
        margin-top: 15px;
        padding: 15px;
        background: var(--bg-card);
        border: 1px solid var(--primary);
        border-radius: 8px;
        font-size: 0.95rem;
        line-height: 1.6;
        color: var(--text-main);
        display: none;
      }

      /* åº•éƒ¨æ“ä½œæ  */
      .action-bar {
        background: var(--bg-card);
        border-top: 1px solid var(--border-color);
        padding: 12px 20px;
        padding-bottom: max(12px, var(--safe-bottom));
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }
      .btn:active { transform: scale(0.98); }
      .btn-secondary { background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border-color); }
      .btn-primary { background: var(--primary); color: white; flex: 2; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); }
      .btn-knowledge { background: var(--warning); color: white; flex: 2; }
      .btn-wrong { background: var(--error); color: white; flex: 2; }
      .btn-exam-submit { background: #8b5cf6; color: white; flex: 2; box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3); }

      .tool-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 20px;
      }
      .text-link {
        font-size: 0.85rem;
        color: var(--text-sub);
        cursor: pointer;
        text-decoration: underline;
        background: none;
        border: none;
      }

      /* æ¨¡æ€æ¡† */
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 45;
        display: none;
        backdrop-filter: blur(2px);
      }
      .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--bg-card);
        padding: 25px;
        border-radius: 16px;
        width: 90%;
        max-width: 400px;
        z-index: 100;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        display: none;
        border: 1px solid var(--border-color);
        color: var(--text-main);
      }
      .modal h3 { margin-top: 0; color: var(--text-main); }
      .form-label { color: var(--text-sub); }
      .form-input {
        background: var(--bg-body);
        color: var(--text-main);
        border: 1px solid var(--border-color);
      }

      /* åº•éƒ¨å·¥å…·æŒ‰é’®ç»„ (Sidebar footer) */
      .sidebar-footer {
        padding: 15px;
        border-top: 1px solid var(--border-color);
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        background: var(--bg-sidebar);
      }
      .footer-btn {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--bg-body);
        color: var(--text-sub);
        font-size: 0.8rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        transition: 0.2s;
      }
      .footer-btn:hover { background: var(--bg-card); color: var(--primary); }

      /* åŠŸèƒ½åŒºæŒ‰é’®æ ·å¼è¡¥å…… */
      .continue-btn {
        background: var(--success); 
        color: white; 
        font-size: 0.8rem; 
        padding: 4px 8px; 
        border-radius: 4px; 
        border: none; 
        cursor: pointer;
        display: none; /* é»˜è®¤éšè—ï¼Œæœ‰æœªåšé¢˜æ‰æ˜¾ç¤º */
        align-items: center;
        gap: 4px;
      }

      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          left: -100%;
          height: 100%;
          width: 85%;
          box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
        }
        .sidebar.open { left: 0; }
        .menu-toggle { display: block; }
        .overlay.active { display: block; }
      }

      @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
  </head>
  <body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="app-brand">âš¡ï¸ å¤ä¹ ç³»ç»Ÿ Pro</div>
        
        <!-- å€’è®¡æ—¶æ¨¡å— -->
        <div class="countdown-box" onclick="editExamDate()" title="ç‚¹å‡»ä¿®æ”¹æ—¥æœŸ">
            <div>è·ç¦»æœŸæœ«è€ƒè¯•è¿˜æœ‰</div>
            <div style="margin:8px 0">
                <span class="countdown-num" id="daysLeft">5</span> å¤©
            </div>
            <div style="font-size:0.75rem; opacity:0.9" id="examDateStr">åŠ æ²¹ï¼å†²åˆºï¼</div>
        </div>

        <!-- æ¨¡å¼é€‰æ‹©åŒº -->
        <div class="mode-group">
            <div class="mod-row">
                <button class="mod-tab active" onclick="switchModule('postgrad')" id="tab-pg">ğŸ“š è€ƒç ”çœŸé¢˜</button>
                <button class="mod-tab" onclick="switchModule('history')" id="tab-hist">ğŸ“ è¯¾åç»ƒä¹ </button>
            </div>
            <div class="mod-row">
                <!-- é”™é¢˜æœ¬ -->
                <button class="mod-tab special-btn" onclick="switchModule('wrong_book')" id="tab-wrong">
                   âŒ é”™é¢˜é›† <span id="wbCount" style="font-size:0.75rem; margin-left:2px; opacity:0.8">(0)</span>
                </button>
                <!-- æ”¶è—å¤¹ -->
                <button class="mod-tab star-tab-btn" onclick="switchModule('favorites')" id="tab-fav">
                   â­ æ”¶è—å¤¹ <span id="favCount" style="font-size:0.75rem; margin-left:2px; opacity:0.8">(0)</span>
                </button>
            </div>
            <div class="mod-row">
                <!-- ä¹±åº -->
                <button class="mod-tab random-btn" onclick="switchModule('random_drill')" id="tab-random">ğŸ”€ ä¹±åºåˆ·é¢˜</button>
                <!-- æ¨¡æ‹Ÿè€ƒè¯• -->
                <button class="mod-tab mock-btn" onclick="startMockExam()" id="tab-mock">ğŸ“ æ¨¡æ‹Ÿè€ƒè¯•</button>
            </div>
        </div>
      </div>

      <div class="chapter-list" id="chapterList"></div>
      
      <!-- åº•éƒ¨å·¥å…·åŒº -->
      <div class="sidebar-footer">
        <button class="footer-btn" onclick="openAiSettings()">âš™ï¸ AI è®¾ç½®</button>
        <button class="footer-btn" onclick="toggleDarkMode()" id="darkModeBtn">ğŸŒ™ å¤œé—´æ¨¡å¼</button>
        <button class="footer-btn" onclick="exportData()">ğŸ’¾ å¤‡ä»½è¿›åº¦</button>
        <button class="footer-btn" onclick="importData()">ğŸ“‚ æ¢å¤è¿›åº¦</button>
        <button class="footer-btn" style="grid-column: span 2; color: var(--error); border-color: #fecdd3;" onclick="resetChapter()">ğŸ—‘ï¸ æ¸…ç©ºå½“å‰ç« èŠ‚</button>
      </div>
    </div>
    
    <div class="overlay" id="overlay" onclick="closeAll()"></div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
    <input type="file" id="fileInput" style="display:none" accept=".json" onchange="handleFileImport(this)">

    <!-- AI è®¾ç½®å¼¹çª— -->
    <div class="modal" id="aiModal">
      <h3>é…ç½® AI æœåŠ¡</h3>
      <div class="form-group" style="margin-bottom:15px">
        <label class="form-label">é€‰æ‹©æœåŠ¡å•†</label>
        <select class="form-input" id="aiProvider" onchange="toggleAiInputs()" style="width:100%; padding:10px; border-radius:8px; margin-top:5px;">
          <option value="gemini">Google Gemini</option>
          <option value="qwen">é€šä¹‰çµç  (é˜¿é‡Œäº‘ DashScope)</option>
          <option value="siliconflow">é€šä¹‰åƒé—® (ç¡…åŸºæµåŠ¨ - æ¨è)</option>
          <option value="custom">Custom (OpenAI Compatible)</option>
        </select>
      </div>

      <div id="geminiConfig">
        <div style="margin-bottom:10px">
          <label class="form-label">API Key</label>
          <input type="password" id="geminiKey" class="form-input" style="width:100%; padding:10px; border-radius:8px; margin-top:5px;" placeholder="ç•™ç©ºä½¿ç”¨å†…ç½®Key" />
        </div>
      </div>
      
      <!-- å…¶ä»–é…ç½®åŒºåŸŸå¤ç”¨åŸé€»è¾‘ï¼Œç®€åŒ–HTMLå±•ç¤º -->
      <div id="qwenConfig" style="display:none; margin-bottom:10px">
         <label class="form-label">API Key (DashScope)</label>
         <input type="password" id="qwenKey" class="form-input" style="width:100%; padding:10px; border-radius:8px; margin-top:5px;" />
      </div>

      <div id="siliconFlowConfig" style="display:none; margin-bottom:10px">
         <label class="form-label">API Key (ç¡…åŸºæµåŠ¨)</label>
         <input type="password" id="sfKey" class="form-input" style="width:100%; padding:10px; border-radius:8px; margin-top:5px;" />
      </div>

      <div id="customConfig" style="display:none; margin-bottom:10px">
         <input type="text" id="customUrl" class="form-input" placeholder="API Base URL" style="width:100%; padding:10px; border-radius:8px; margin-top:5px; margin-bottom:5px;" />
         <input type="password" id="customKey" class="form-input" placeholder="API Key" style="width:100%; padding:10px; border-radius:8px;" />
      </div>

      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
        <button class="btn btn-secondary" onclick="closeAll()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveAiSettings()">ä¿å­˜é…ç½®</button>
      </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div class="main-content">
      <!-- æ¨¡æ‹Ÿè€ƒè¯•è®¡æ—¶æ¡ -->
      <div class="exam-timer-bar" id="examTimerBar">
          <div>â³ è·ç¦»äº¤å·è¿˜æœ‰ï¼š<span id="examCountdown" style="color:#fbbf24; font-size:1.2rem">45:00</span></div>
          <button style="background:#ef4444; border:none; color:white; padding:4px 12px; border-radius:4px; cursor:pointer" onclick="submitMockExam()">ğŸ“¥ æå‰äº¤å·</button>
      </div>

      <div class="top-nav" id="normalTopNav">
        <div class="nav-row">
          <div style="display: flex; align-items: center; overflow: hidden; gap:10px; flex:1">
            <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
            <div style="display:flex; flex-direction:column; overflow:hidden;">
                <div class="nav-title" id="headerTitle">è¯·é€‰æ‹©ç« èŠ‚</div>
                <!-- å¿«æ·è·³è½¬æŒ‰é’® -->
                <button id="continueBtn" class="continue-btn" onclick="jumpToUnfinished()">
                    â­ï¸ ç»§ç»­åˆ·é¢˜ (<span id="unfinishedCount">0</span>)
                </button>
            </div>
          </div>
          <select
            class="jump-box"
            id="qJumper"
            onchange="jumpTo(this.value)"
            disabled
          >
            <option>ç¬¬ 0/0 é¢˜</option>
          </select>
        </div>

        <div class="filter-scroll" id="filterBar">
          <button class="filter-chip active" onclick="setFilter('all')">â™¾ï¸ å…¨éƒ¨</button>
          <button class="filter-chip" onclick="setFilter('çŸ¥è¯†ç‚¹')">ğŸ’¡ çŸ¥è¯†ç‚¹</button>
          <button class="filter-chip" onclick="setFilter('å•é€‰')">ğŸ”´ å•é€‰é¢˜</button>
          <button class="filter-chip" onclick="setFilter('å¤šé€‰')">ğŸ”µ å¤šé€‰é¢˜</button>
          <button class="filter-chip" onclick="setFilter('ç®€ç­”')">ğŸŸ¢ ç®€ç­”é¢˜</button>
          <button class="filter-chip" onclick="setFilter('ææ–™')">ğŸ“œ ææ–™é¢˜</button>
        </div>
      </div>

      <div class="content-area" id="qContainer">
        <div style="text-align: center; margin-top: 100px; color: var(--text-sub)">
          <div style="font-size: 3rem; margin-bottom: 10px">ğŸ‘ˆ</div>
          è¯·åœ¨å·¦ä¾§ç›®å½•é€‰æ‹©æ¨¡å¼å¼€å§‹å¤ä¹ 
        </div>
      </div>

      <div class="tool-row" id="toolRow">
        <button class="text-link" onclick="toggleAns()">ğŸ‘ï¸ æ˜¾ç¤º/éšè—ç­”æ¡ˆ</button>
        <span id="scoreText" style="font-size: 0.85rem; color: var(--text-sub)"></span>
      </div>

      <div class="action-bar">
        <button class="btn btn-secondary" onclick="move(-1)">â¬…ï¸ ä¸Šä¸€é¢˜</button>
        <button
          class="btn btn-primary"
          id="mainBtn"
          onclick="handleMainAction()"
        >
          âœ… æäº¤ç­”æ¡ˆ
        </button>
        <button class="btn btn-secondary" onclick="move(1)">ä¸‹ä¸€é¢˜ â¡ï¸</button>
      </div>
    </div>

    <script>
      // === é…ç½®ä¸çŠ¶æ€ ===
      const modules = {
        postgrad: { name: "è€ƒç ”çœŸé¢˜", data: [], prefix: "pg_" },
        history: { name: "è¯¾åç»ƒä¹ ", data: [], prefix: "hist_" },
        wrong_book: { name: "é”™é¢˜é›†", data: [], prefix: "wb_" },
        random_drill: { name: "ä¹±åºåˆ·é¢˜", data: [], prefix: "rd_" },
        favorites: { name: "æ”¶è—å¤¹", data: [], prefix: "fav_" },
        mock_exam: { name: "å…¨çœŸæ¨¡æ‹Ÿè€ƒè¯•", data: [], prefix: "mock_" }
      };

      const BUILTIN_API_KEY = "sk-60ffb14cd765472bb2de892c632ad0dc"; 

      let curMod = localStorage.getItem("last_mod") || "postgrad";
      let allData = [];
      let curChapter = "";
      let rawList = []; 
      let filteredList = [];
      let curIndex = 0; 
      let filterType = "all";
      let userSel = new Set(); 
      let wrongSet = new Set();
      let favoriteSet = new Set();
      
      // æ¨¡æ‹Ÿè€ƒè¯•ç›¸å…³
      let isExamMode = false;
      let examTimer = null;
      let examSeconds = 45 * 60;

      // === åˆå§‹åŒ– ===
      window.onload = async () => {
        try {
          initDarkMode();
          initCountdown();

          const [res1, res2] = await Promise.allSettled([
            fetch("./questions.json").then((r) => r.json()),
            fetch("./history_questions.json").then((r) => r.json()),
          ]);

          modules.postgrad.data = frontendRepair(res1.status === "fulfilled" ? res1.value : []);
          modules.history.data = frontendRepair(res2.status === "fulfilled" ? res2.value : []);

          assignIds(modules.postgrad.data, "pg");
          assignIds(modules.history.data, "hist");

          // åŠ è½½é”™é¢˜å’Œæ”¶è—
          loadAndCleanSets();
          
          // === è‡ªåŠ¨åŒæ­¥ä¿®å¤ ===
          // æ£€æµ‹æ‰€æœ‰ç« èŠ‚è¿›åº¦ï¼Œå¦‚æœæœ‰é”™é¢˜ä½†æ²¡åœ¨é”™é¢˜æœ¬é‡Œï¼Œè‡ªåŠ¨åŠ å›å»
          syncWrongBookFromProgress();

          switchModule(curMod);
        } catch (e) {
          console.error(e);
          alert("æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ questions.json æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚");
        }
      };
      
      // === é”™é¢˜åŒæ­¥ä¿®å¤åŠŸèƒ½ ===
      function syncWrongBookFromProgress() {
        let hasUpdates = false;
        
        // è¾…åŠ©å‡½æ•°ï¼šæ‰«æä¸€ä¸ªæ¨¡å—çš„æ‰€æœ‰ç« èŠ‚
        const processModule = (modKey) => {
            const mod = modules[modKey];
            if (!mod || !mod.data) return;
            
            // æŒ‰ç« èŠ‚åˆ†ç»„ï¼Œä»¥ä¾¿åŒ¹é… localStorage çš„å­˜å‚¨ç»“æ„
            const chapMap = {};
            mod.data.forEach(q => {
                if (!chapMap[q.chapter]) chapMap[q.chapter] = [];
                chapMap[q.chapter].push(q);
            });
            
            // éå†æ‰€æœ‰ç« èŠ‚
            for (const [chapName, qList] of Object.entries(chapMap)) {
                const key = mod.prefix + chapName;
                const savedJson = localStorage.getItem(key);
                if (!savedJson) continue;
                
                try {
                    const saved = JSON.parse(savedJson);
                    // éå†è¯¥ç« èŠ‚çš„æ¯é“é¢˜
                    qList.forEach((q, i) => {
                        // saved[i] å¯¹åº” qList[i]
                        if (saved[i] && saved[i].done) {
                             // æ„é€ ä¸´æ—¶å¯¹è±¡æ¥å¤ç”¨ getQuestionStatus åˆ¤åˆ†é€»è¾‘
                             const tempQ = { 
                                 ...q, 
                                 isSubmitted: true, 
                                 userSel: new Set(saved[i].sel || []) 
                             };
                             
                             // åªåŒæ­¥é€‰æ‹©é¢˜
                             if (q.type && q.type.includes("é€‰")) {
                                 const status = getQuestionStatus(tempQ);
                                 // å¦‚æœåˆ¤åˆ†ä¸ºé”™æˆ–åŠå¯¹ï¼Œä¸”ä¸åœ¨é”™é¢˜æœ¬é‡Œï¼ŒåŠ è¿›å»
                                 if (status === 'wrong' || status === 'partial') {
                                     if (!wrongSet.has(q._uid)) {
                                         wrongSet.add(q._uid);
                                         hasUpdates = true;
                                     }
                                 }
                             }
                        }
                    });
                } catch (e) { console.error("Sync error", e); }
            }
        };

        processModule('postgrad');
        processModule('history');
        
        if (hasUpdates) {
            localStorage.setItem("wrong_questions", JSON.stringify(Array.from(wrongSet)));
            updateCounts();
            console.log("å·²è‡ªåŠ¨ä»åšé¢˜è¿›åº¦ä¸­åŒæ­¥æ¢å¤é”™é¢˜ã€‚");
        }
      }
      
      // === å€’è®¡æ—¶åŠŸèƒ½ ===
      function initCountdown() {
          const storedDate = localStorage.getItem("exam_date");
          let targetDate;
          if (storedDate) {
              targetDate = new Date(storedDate);
          } else {
              targetDate = new Date();
              targetDate.setDate(targetDate.getDate() + 5); // é»˜è®¤5å¤©å
          }
          updateCountdownDisplay(targetDate);
      }
      
      function updateCountdownDisplay(targetDate) {
          const now = new Date();
          // è®¾ç½®ä¸ºå½“å¤©çš„ 00:00:00 è¿›è¡Œæ¯”è¾ƒï¼Œæˆ–è€…ç›´æ¥ç®—æ—¶é—´å·®
          targetDate.setHours(0,0,0,0);
          const today = new Date();
          today.setHours(0,0,0,0);
          
          const diffTime = targetDate - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          
          document.getElementById("daysLeft").innerText = diffDays > 0 ? diffDays : 0;
          document.getElementById("examDateStr").innerText = `è€ƒè¯•æ—¥æœŸ: ${targetDate.getFullYear()}-${targetDate.getMonth()+1}-${targetDate.getDate()}`;
          
          localStorage.setItem("exam_date", targetDate.toISOString());
      }
      
      window.editExamDate = function() {
          const cur = localStorage.getItem("exam_date");
          const dateStr = cur ? cur.slice(0, 10) : new Date().toISOString().slice(0, 10);
          const input = prompt("è¯·è®¾ç½®è€ƒè¯•æ—¥æœŸ (æ ¼å¼: YYYY-MM-DD)", dateStr);
          if (input && /^\d{4}-\d{2}-\d{2}$/.test(input)) {
              updateCountdownDisplay(new Date(input));
          }
      }

      // é”™é¢˜æœ¬å’Œæ”¶è—å¤¹æ•°æ®åŠ è½½
      function loadAndCleanSets() {
          const wSaved = localStorage.getItem("wrong_questions");
          const fSaved = localStorage.getItem("favorite_questions");
          
          // æ„å»ºæ‰€æœ‰æœ‰æ•ˆID
          const allIds = new Set();
          [...modules.postgrad.data, ...modules.history.data].forEach(q => allIds.add(q._uid));
          
          // æ¸…æ´—é”™é¢˜
          wrongSet = new Set();
          if (wSaved) {
              JSON.parse(wSaved).forEach(id => { if (allIds.has(id)) wrongSet.add(id); });
          }
          
          // æ¸…æ´—æ”¶è—
          favoriteSet = new Set();
          if (fSaved) {
              JSON.parse(fSaved).forEach(id => { if (allIds.has(id)) favoriteSet.add(id); });
          }
          
          updateCounts();
      }

      function updateCounts() {
          const wEl = document.getElementById("wbCount");
          if(wEl) wEl.innerText = `(${wrongSet.size})`;
          
          const fEl = document.getElementById("favCount");
          if(fEl) fEl.innerText = `(${favoriteSet.size})`;
      }

      function assignIds(data, prefix) {
        if (!data) return;
        data.forEach((q, idx) => {
            const str = q.chapter + q.content.substring(0,10);
            let hash = 0;
            for(let i=0; i<str.length; i++) hash = (hash<<5) - hash + str.charCodeAt(i);
            q._uid = `${prefix}_${Math.abs(hash)}_${idx}`;
        });
      }

      function frontendRepair(data) {
        if (!data) return [];
        return data.map((q) => {
          if (q.type === "çŸ¥è¯†ç‚¹") return q;
          if (q.type && q.type.includes("é€‰") && (!q.options || q.options.length === 0)) {
            const parts = q.content.split(/\s(?=[A-E][\.ï¼ã€])/);
            if (parts.length > 1) {
              q.content = parts[0]; 
              q.options = [];
              for (let i = 1; i < parts.length; i++) {
                const t = parts[i].trim();
                q.options.push({
                  label: t.charAt(0),
                  text: t.substring(1).replace(/^[\.ï¼ã€]/, "").trim(),
                });
              }
            }
          }
          return q;
        });
      }

      // === æ¨¡å—é€»è¾‘ ===
      function switchModule(key) {
        if (isExamMode && key !== 'mock_exam') {
            if(!confirm("æ­£åœ¨è€ƒè¯•ä¸­ï¼Œåˆ‡æ¢æ¨¡å¼å°†è‡ªåŠ¨äº¤å·ï¼Œç¡®å®šå—ï¼Ÿ")) return;
            endExamMode();
        }
        
        curMod = key;
        localStorage.setItem("last_mod", key);

        document.querySelectorAll('.mod-tab').forEach(btn => btn.classList.remove('active'));
        if(key === 'wrong_book') document.getElementById('tab-wrong').classList.add('active');
        else if(key === 'favorites') document.getElementById('tab-fav').classList.add('active');
        else if(key === 'random_drill') document.getElementById('tab-random').classList.add('active');
        else if(key === 'mock_exam') document.getElementById('tab-mock').classList.add('active');
        else if(key === 'postgrad') document.getElementById('tab-pg').classList.add('active');
        else document.getElementById('tab-hist').classList.add('active');

        document.getElementById("continueBtn").style.display = "none";
        
        // ç¡®ä¿é¡¶éƒ¨å¯¼èˆªæ æ¢å¤æ­£å¸¸
        document.getElementById("examTimerBar").classList.remove("active");
        document.getElementById("normalTopNav").style.display = "flex";
        document.getElementById("toolRow").style.display = "flex";

        if (key === 'wrong_book') {
            loadWrongBook();
        } else if (key === 'favorites') {
            loadFavorites();
        } else if (key === 'random_drill') {
            loadRandomDrill();
        } else if (key === 'mock_exam') {
            // æ³¨æ„ï¼šswitchModuleåªæ˜¯åˆ‡æ¢UIé«˜äº®ï¼ŒstartMockExamæ‰æ˜¯çœŸæ­£å¼€å§‹é€»è¾‘
            // å¦‚æœç”¨æˆ·ç‚¹å‡»ä¾§è¾¹æ æŒ‰é’®ï¼Œåº”è¯¥è§¦å‘startMockExam
            // è¿™é‡Œä¸ºäº†é˜²æ­¢é€’å½’è°ƒç”¨ï¼Œä¸åšå¤„ç†ï¼ŒstartMockExamä¼šè‡ªå·±å¤„ç†
        } else {
            allData = modules[key].data;
            curChapter = "";
            rawList = [];
            filteredList = [];
            initSidebar(); 
            document.getElementById("qContainer").innerHTML = 
                `<div style="text-align:center; margin-top:100px; color:var(--text-sub);">
                   <div style="font-size:2rem;margin-bottom:10px">ğŸ“‚</div>
                   å·²åˆ‡æ¢è‡³ ${modules[key].name}<br>è¯·åœ¨å·¦ä¾§é€‰æ‹©ç« èŠ‚
                 </div>`;
            document.getElementById("headerTitle").innerText = "è¯·é€‰æ‹©ç« èŠ‚";
            document.getElementById("qJumper").disabled = true;
        }
      }

      function loadWrongBook() {
        const pool = [...modules.postgrad.data, ...modules.history.data];
        rawList = pool.filter(q => wrongSet.has(q._uid));
        rawList.forEach(q => { q.isSubmitted = false; q.userSel = new Set(); });
        
        document.getElementById("chapterList").innerHTML = 
            `<div style="padding:15px; color:var(--text-sub); text-align:center">
                å…±æ”¶é›†é”™é¢˜ <strong>${rawList.length}</strong> é“
             </div>`;
        curChapter = "é”™é¢˜æœ¬";
        setFilter('all');
        if(rawList.length === 0) showEmptyState("ğŸ‰ å¤ªæ£’äº†ï¼æ²¡æœ‰é”™é¢˜ï¼");
      }
      
      function loadFavorites() {
        const pool = [...modules.postgrad.data, ...modules.history.data];
        rawList = pool.filter(q => favoriteSet.has(q._uid));
        // æ”¶è—å¤¹é‡Œçš„é¢˜ï¼Œä¿ç•™åšé¢˜è®°å½•ä¹Ÿæ²¡å…³ç³»ï¼Œæˆ–è€…æ˜¯é‡ç½®ï¼Ÿä¸ºäº†å¤ä¹ ï¼Œé»˜è®¤é‡ç½®
        rawList.forEach(q => { q.isSubmitted = false; q.userSel = new Set(); });

        document.getElementById("chapterList").innerHTML = 
            `<div style="padding:15px; color:var(--text-sub); text-align:center">
                å…±æ”¶è—é‡ç‚¹ <strong>${rawList.length}</strong> é“
             </div>`;
        curChapter = "æˆ‘çš„æ”¶è—";
        setFilter('all');
        if(rawList.length === 0) showEmptyState("ğŸ“‚ æ”¶è—å¤¹æ˜¯ç©ºçš„<br>é‡åˆ°é‡ç‚¹é¢˜è®°å¾—ç‚¹æ˜Ÿæ˜Ÿæ”¶è—å“¦");
      }

      function loadRandomDrill() {
        let pool = [...modules.postgrad.data, ...modules.history.data]
            .filter(q => q.type && q.type.includes("é€‰"));
        
        for (let i = pool.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [pool[i], pool[j]] = [pool[j], pool[i]];
        }
        
        rawList = pool;
        document.getElementById("chapterList").innerHTML = 
            `<div style="padding:15px; color:var(--text-sub); text-align:center">
                å…¨åº“ä¹±åºæ¨¡å¼<br>å…± <strong>${rawList.length}</strong> é“é€‰æ‹©é¢˜
             </div>`;
        
        curChapter = "ä¹±åºåˆ·é¢˜";
        rawList.forEach(q => { q.userSel = new Set(); q.isSubmitted = false; });
        setFilter('all');
      }
      
      function showEmptyState(msg) {
          document.getElementById("qContainer").innerHTML = 
                `<div style="text-align:center; margin-top:100px; color:var(--text-sub);">
                    ${msg}
                 </div>`;
      }

      // === æ¨¡æ‹Ÿè€ƒè¯•é€»è¾‘ ===
      window.startMockExam = function() {
          if (isExamMode) return;
          if(!confirm("å³å°†å¼€å§‹å…¨çœŸæ¨¡æ‹Ÿè€ƒè¯•ï¼š\n\n1. åŒ…å«30é“å•é€‰ã€10é“å¤šé€‰ã€5é“å¤§é¢˜\n2. é™æ—¶45åˆ†é’Ÿ\n3. ä¸­é€”ä¸èƒ½çœ‹ç­”æ¡ˆ\n\nå‡†å¤‡å¥½äº†å—ï¼Ÿ")) return;
          
          isExamMode = true;
          switchModule('mock_exam'); // åˆ‡æ¢UI
          
          // 1. æŠ½é¢˜
          const pool = [...modules.postgrad.data, ...modules.history.data];
          const singles = pool.filter(q => q.type && q.type.includes("å•é€‰"));
          const multis = pool.filter(q => q.type && q.type.includes("å¤šé€‰"));
          const others = pool.filter(q => !q.type || (!q.type.includes("å•é€‰") && !q.type.includes("å¤šé€‰") && q.type !== "çŸ¥è¯†ç‚¹"));
          
          const examList = [];
          
          // éšæœºæŠ½
          function pick(arr, count) {
              const res = [];
              const indices = new Set();
              while(res.length < count && indices.size < arr.length) {
                  const idx = Math.floor(Math.random() * arr.length);
                  if(!indices.has(idx)) {
                      indices.add(idx);
                      // æ·±æ‹·è´é¢˜ç›®å¯¹è±¡ï¼Œä»¥å…æ±¡æŸ“åŸé¢˜çŠ¶æ€
                      const q = JSON.parse(JSON.stringify(arr[idx]));
                      // ç¡®ä¿ _uid è¿˜åœ¨
                      q._uid = arr[idx]._uid; 
                      q.userSel = new Set();
                      q.isSubmitted = false;
                      res.push(q);
                  }
              }
              return res;
          }
          
          examList.push(...pick(singles, 30));
          examList.push(...pick(multis, 10));
          examList.push(...pick(others, 5));
          
          rawList = examList;
          filteredList = examList;
          curIndex = 0;
          curChapter = "å…¨çœŸæ¨¡æ‹Ÿè€ƒè¯•";
          
          // 2. UI è°ƒæ•´
          document.getElementById("chapterList").innerHTML = 
            `<div style="padding:15px; color:var(--text-sub); text-align:center">
                ğŸ“ è€ƒè¯•è¿›è¡Œä¸­...<br>å…± <strong>${rawList.length}</strong> é“é¢˜
             </div>`;
             
          document.getElementById("normalTopNav").style.display = "none";
          document.getElementById("examTimerBar").classList.add("active");
          document.getElementById("toolRow").style.display = "none"; // éšè—ç­”æ¡ˆæŒ‰é’®
          
          // 3. å¯åŠ¨è®¡æ—¶å™¨
          examSeconds = 45 * 60;
          updateTimerDisplay();
          examTimer = setInterval(() => {
              examSeconds--;
              updateTimerDisplay();
              if (examSeconds <= 0) {
                  submitMockExam(true);
              }
          }, 1000);
          
          renderQ();
      };
      
      function updateTimerDisplay() {
          const m = Math.floor(examSeconds / 60).toString().padStart(2, '0');
          const s = (examSeconds % 60).toString().padStart(2, '0');
          const el = document.getElementById("examCountdown");
          el.innerText = `${m}:${s}`;
          if(examSeconds < 300) el.style.color = "#ef4444"; // æœ€å5åˆ†é’Ÿå˜çº¢
      }
      
      window.submitMockExam = function(force = false) {
          if (!force && !confirm("ç¡®å®šè¦äº¤å·å—ï¼Ÿäº¤å·åå°†æ˜¾ç¤ºåˆ†æ•°å’Œè§£æã€‚")) return;
          
          endExamMode();
          
          // ç®—åˆ†é€»è¾‘
          let score = 0;
          let totalScore = 0;
          // å‡è®¾å•é€‰2åˆ†ï¼Œå¤šé€‰3åˆ†ï¼Œå…¶ä»–5åˆ†
          rawList.forEach(q => {
              // æ¨¡æ‹Ÿè€ƒè¯•äº¤å·æ—¶ï¼Œç»Ÿä¸€æŠŠé¢˜ç›®è®¾ä¸º submitted
              q.isSubmitted = true;
              
              if (q.type.includes("å•é€‰")) {
                  totalScore += 2;
                  if (getQuestionStatus(q) === 'correct') score += 2;
              } else if (q.type.includes("å¤šé€‰")) {
                  totalScore += 3;
                  if (getQuestionStatus(q) === 'correct') score += 3;
                  else if (getQuestionStatus(q) === 'partial') score += 1;
              } else {
                  totalScore += 5;
                  // ä¸»è§‚é¢˜æ²¡æ³•è‡ªåŠ¨åˆ¤åˆ†ï¼Œé»˜è®¤ç®—å¯¹æˆ–è€…ä¸ç®—åˆ†ï¼Œè¿™é‡Œä»…å±•ç¤º
              }
          });
          
          // æ¢å¤UI
          document.getElementById("normalTopNav").style.display = "flex";
          document.getElementById("toolRow").style.display = "flex";
          document.getElementById("examTimerBar").classList.remove("active");
          
          alert(`è€ƒè¯•ç»“æŸï¼\n\nå®¢è§‚é¢˜å¾—åˆ†é¢„ä¼°ï¼š${score} / ${totalScore} (ä¸å«ä¸»è§‚é¢˜)\n\nç°åœ¨æ‚¨å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è§£æäº†ã€‚`);
          
          setFilter('all'); // åˆ·æ–°åˆ—è¡¨çŠ¶æ€
      };
      
      function endExamMode() {
          if (examTimer) clearInterval(examTimer);
          isExamMode = false;
      }

      function initSidebar() {
        const list = document.getElementById("chapterList");
        list.innerHTML = "";

        const map = new Map();
        allData.forEach((q) => {
            if (!map.has(q.chapter)) map.set(q.chapter, 0);
            map.set(q.chapter, map.get(q.chapter) + 1);
        });

        map.forEach((total, cName) => {
            const key = modules[curMod].prefix + cName;
            const saved = JSON.parse(localStorage.getItem(key) || "[]");
            const done = saved.filter((x) => x && x.done).length;
            const pct = total > 0 ? Math.round((done / total) * 100) : 0;

            const div = document.createElement("div");
            div.className = "chapter-item";
            if (cName === curChapter) div.classList.add("active");
            
            const topRow = document.createElement("div");
            topRow.className = "chap-row-top";
            topRow.innerHTML = `<span>${cName}</span><span class="badge-pill">${done}/${total}</span>`;
            
            const progressTrack = document.createElement("div");
            progressTrack.className = "progress-track";
            const progressFill = document.createElement("div");
            progressFill.className = "progress-fill";
            progressFill.style.width = `${pct}%`;
            progressTrack.appendChild(progressFill);

            div.appendChild(topRow);
            div.appendChild(progressTrack);

            div.onclick = () => loadChapter(cName);
            list.appendChild(div);
        });
      }

      function loadChapter(cName) {
        curChapter = cName;
        rawList = allData.filter((q) => q.chapter === cName);

        const key = modules[curMod].prefix + cName;
        const saved = JSON.parse(localStorage.getItem(key) || "[]");
        
        rawList.forEach((q, i) => {
          if (saved[i]) {
            q.userSel = new Set(saved[i].sel || []);
            q.isSubmitted = saved[i].done || false;
          } else {
            q.userSel = new Set();
            q.isSubmitted = false;
          }
        });

        setFilter(filterType);
        initSidebar();
        updateContinueBtn(); 
        
        if (window.innerWidth <= 768) {
             document.getElementById("sidebar").classList.remove("open");
             document.getElementById("overlay").classList.remove("active");
        }
      }

      function updateContinueBtn() {
          const unfinishedCount = rawList.filter(q => !q.isSubmitted).length;
          const btn = document.getElementById("continueBtn");
          const countSpan = document.getElementById("unfinishedCount");
          
          if(unfinishedCount > 0 && curMod !== 'wrong_book' && curMod !== 'random_drill' && curMod !== 'favorites') {
              btn.style.display = "flex";
              countSpan.innerText = unfinishedCount;
          } else {
              btn.style.display = "none";
          }
      }

      function jumpToUnfinished() {
          const idx = filteredList.findIndex(q => !q.isSubmitted);
          if (idx !== -1) {
              jumpTo(idx);
          } else {
              alert("å½“å‰åˆ—è¡¨é¢˜ç›®å·²å…¨éƒ¨åšå®Œï¼");
          }
      }

      function getQuestionStatus(q) {
          if (!q.isSubmitted) return 'none';
          if (q.type === 'çŸ¥è¯†ç‚¹') return 'correct';
          
          if (!q.options || q.options.length === 0) return 'correct'; 

          const correctArr = (q.answer || "").toUpperCase().split("").filter(c => /[A-Z]/.test(c));
          const correctSet = new Set(correctArr);
          const userSet = q.userSel || new Set();

          let hasWrong = false;
          for (let s of userSet) {
              if (!correctSet.has(s)) {
                  hasWrong = true;
                  break;
              }
          }

          if (hasWrong) return 'wrong';
          if (userSet.size === correctSet.size) return 'correct';
          if (userSet.size > 0 && userSet.size < correctSet.size) return 'partial';
          if (userSet.size === 0 && correctSet.size > 0) return 'wrong';
          
          return 'correct';
      }

      function setFilter(type) {
        filterType = type;
        document.querySelectorAll(".filter-chip").forEach((b) => {
          b.className = b.innerText.includes(type === "all" ? "å…¨éƒ¨" : type)
            ? "filter-chip active"
            : "filter-chip";
        });

        if (type === "all") filteredList = rawList;
        else
          filteredList = rawList.filter((q) => q.type && q.type.includes(type));

        const sel = document.getElementById("qJumper");
        sel.innerHTML = "";
        
        if (filteredList.length === 0) {
          sel.disabled = true;
          document.getElementById("qContainer").innerHTML = 
            `<div style="text-align:center;margin-top:50px;color:var(--text-sub)">æ²¡æœ‰æ­¤ç±»é¢˜ç›®</div>`;
          return;
        }

        sel.disabled = false;
        
        filteredList.forEach((q, i) => {
          const status = getQuestionStatus(q);
          let mark = "";
          if (status === 'correct') mark = " âœ…";
          else if (status === 'partial') mark = " ğŸŒ—";
          else if (status === 'wrong') mark = " âŒ";

          sel.add(new Option(`${i + 1}. ${shorten(q.content)}${mark}`, i));
        });

        if(curIndex >= filteredList.length) curIndex = 0;
        
        renderQ();
      }

      function shorten(s) {
        return s.length > 8 ? s.substring(0, 8) + "..." : s;
      }

      // === æ¸²æŸ“ ===
      function renderQ() {
        if (!filteredList.length) return;
        const q = filteredList[curIndex];

        // è€ƒè¯•æ¨¡å¼ä¸‹ï¼Œä¸‹æ‹‰æ¡†ç¦ç”¨è·³è½¬ï¼Œæˆ–è€…åªå…è®¸è·³è½¬ï¼ˆä½†ä¸æ˜¾ç¤ºç­”æ¡ˆçŠ¶æ€ï¼‰
        if (isExamMode) {
            document.getElementById("headerTitle").innerText = `æ¨¡æ‹Ÿè€ƒ: ç¬¬ ${curIndex + 1} / ${filteredList.length} é¢˜`;
        } else {
            document.getElementById("headerTitle").innerText = curChapter;
            document.getElementById("qJumper").value = curIndex;
        }
        
        // æ¢å¤ç”¨æˆ·é€‰æ‹©ï¼ˆå¦‚æœæ˜¯Setå¯¹è±¡åˆ™ä¿ç•™ï¼Œå¦‚æœæ˜¯æ•°ç»„åˆ™è½¬æ¢ï¼‰
        if (!(q.userSel instanceof Set)) q.userSel = new Set(q.userSel || []);
        userSel = new Set(q.userSel);

        const container = document.getElementById("qContainer");

        let cardClass = "card";
        let btnText = "âœ… æäº¤ç­”æ¡ˆ";
        let btnClass = "btn btn-primary";

        if (curMod === 'wrong_book') cardClass += " wrong-mode";
        else if (curMod === 'favorites') cardClass += " fav-mode";
        else if (q.type === "çŸ¥è¯†ç‚¹") {
            cardClass += " knowledge-mode";
            btnText = q.isSubmitted ? "å·²èƒŒç†Ÿ" : "ğŸ‘Œ è®°ä½äº†";
            btnClass = "btn btn-knowledge";
        } else if (q.type === "ææ–™é¢˜") cardClass += " material-mode";

        // è€ƒè¯•æ¨¡å¼ä¸‹ï¼ŒæŒ‰é’®åªæœ‰ä¸‹ä¸€é¢˜ï¼Œæ²¡æœ‰â€œæäº¤â€
        if (isExamMode) {
            btnText = curIndex < filteredList.length - 1 ? "ä¸‹ä¸€é¢˜ â¡ï¸" : "å®Œæˆ (è¯·ç‚¹å‡»é¡¶éƒ¨äº¤å·)";
            btnClass = "btn btn-secondary"; 
            if(curIndex === filteredList.length - 1) btnClass = "btn btn-exam-submit";
        } else {
            if (q.isSubmitted && q.type !== "çŸ¥è¯†ç‚¹") {
               btnText = curIndex < filteredList.length - 1 ? "ä¸‹ä¸€é¢˜ â¡ï¸" : "å®Œæˆæœ¬ç« ";
            }
        }

        const mBtn = document.getElementById("mainBtn");
        mBtn.innerText = btnText;
        mBtn.className = btnClass;
        
        // è€ƒè¯•æ¨¡å¼ç‚¹å‡»ä¸»æŒ‰é’®é€»è¾‘ä¸åŒ
        mBtn.onclick = isExamMode ? function() { move(1); } : handleMainAction;

        let bodyHtml = "";
        
        // çŠ¶æ€å¾½ç«  (è€ƒè¯•æ¨¡å¼ä¸æ˜¾ç¤º)
        let statusBadge = "";
        if(!isExamMode && q.isSubmitted && q.type !== "çŸ¥è¯†ç‚¹" && q.type !== "ææ–™é¢˜" && q.type !== "ç®€ç­”é¢˜") {
            const status = getQuestionStatus(q);
            if(status === "wrong") statusBadge = `<div class="status-badge status-wrong">âŒ å›ç­”é”™è¯¯</div>`;
            else if (status === "partial") statusBadge = `<div class="status-badge status-partial">âš ï¸ æ¼é€‰ï¼ˆç®—åŠå¯¹ï¼‰</div>`;
            else statusBadge = `<div class="status-badge status-correct">âœ… å›ç­”æ­£ç¡®</div>`;
        }

        // é€‰é¡¹æ¸²æŸ“
        if (q.type === "çŸ¥è¯†ç‚¹") {
          bodyHtml = `<div style="font-size:1.1rem; line-height:1.8; color:var(--text-main); font-weight:500">${q.content}</div>`;
        } else if (q.options && q.options.length > 0) {
          bodyHtml = `<div class="opts-container">
              ${q.options.map((opt) => {
                  let cls = "opt-row";
                  const correctSet = new Set((q.answer || "").toUpperCase().split(""));
                  
                  // è€ƒè¯•æ¨¡å¼åªæ˜¾ç¤ºé€‰ä¸­çŠ¶æ€ï¼Œä¸æ˜¾ç¤ºå¯¹é”™
                  if (isExamMode) {
                      if (userSel.has(opt.label)) cls += " selected";
                  } else {
                      if (q.isSubmitted) {
                        if (correctSet.has(opt.label)) {
                            cls += " correct";
                            if (!userSel.has(opt.label)) cls += " missed";
                        } else if (userSel.has(opt.label)) {
                            cls += " wrong";
                        }
                      } else {
                        if (userSel.has(opt.label)) cls += " selected";
                      }
                  }
                  
                  return `
                 <div class="${cls}" onclick="handleOpt('${opt.label}')">
                   <div class="opt-idx">${opt.label}</div>
                   <div style="flex:1">${opt.text}</div>
                 </div>`;
                }).join("")}
            </div>`;
        } else {
          bodyHtml = `<div style="padding:15px; background:var(--bg-body); border-radius:8px; color:var(--text-sub); font-style:italic">
              (è¯·åœ¨å¿ƒä¸­ä½œç­”ï¼Œç„¶åç‚¹å‡»æäº¤æŸ¥çœ‹å‚è€ƒç­”æ¡ˆ)
            </div>`;
        }
        
        // æ”¶è—çŠ¶æ€
        const isFav = favoriteSet.has(q._uid);
        const starHtml = `<span class="star-icon ${isFav ? 'active' : ''}" onclick="toggleFav('${q._uid}')">${isFav ? 'â­' : 'â˜†'}</span>`;

        const showAiBtn = !isExamMode && q.isSubmitted && q.type !== "çŸ¥è¯†ç‚¹";
        const showRemoveBtn = curMod === 'wrong_book'; 

        container.innerHTML = `
          <div class="${cardClass}">
             <div class="q-header">
                <div>
                    <span class="q-type">${q.type || "é¢˜ç›®"}</span>
                    ${starHtml}
                </div>
                <span style="font-size:0.8rem; color:var(--text-sub)">${curIndex + 1} / ${filteredList.length}</span>
             </div>
             ${q.type !== "çŸ¥è¯†ç‚¹" ? `<div class="q-content">${q.content}</div>` : ""}
             ${bodyHtml}
             
             <!-- è€ƒè¯•æ¨¡å¼ä¸‹éšè—ç­”æ¡ˆåŒºï¼Œç›´åˆ°äº¤å· -->
             <div class="answer-section ${(!isExamMode && q.isSubmitted) ? "show" : ""}" id="ansPanel">
                ${statusBadge}
                <div style="margin-bottom:10px;">
                   <span style="font-weight:bold; color:var(--text-main)">å‚è€ƒç­”æ¡ˆï¼š</span>
                   <span style="color:var(--primary); font-weight:bold; font-size:1.1rem">${q.answer || "ç•¥"}</span>
                </div>
                <div style="font-size:0.95rem; color:var(--text-main); border-top:1px solid var(--border-color); padding-top:10px; line-height:1.6">
                   <strong>è§£æï¼š</strong><br>${q.explanation || "æš‚æ— "}
                </div>
                
                ${showRemoveBtn ? `
                <button class="btn btn-secondary" style="margin-top:15px; width:100%; border:1px solid #fca5a5; color:#dc2626; background:#fef2f2" onclick="removeFromWrongBook('${q._uid}')">
                    ğŸ—‘ï¸ æˆ‘å­¦ä¼šäº†ï¼Œç§»å‡ºé”™é¢˜æœ¬
                </button>` : ''}

                ${showAiBtn ? `
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:15px;">
                  <button class="btn btn-primary" style="flex:1; background: linear-gradient(135deg, #6366f1, #8b5cf6);" onclick="askAI()">ğŸ¤– AI æ·±åº¦è§£æ</button>
                  <button class="btn btn-secondary" style="flex:1" onclick="copyPrompt()">ğŸ“‹ å¤åˆ¶é¢˜ç›®</button>
                </div>
                <div id="aiResult" class="ai-result"></div>` : ''}
             </div>
          </div>
        `;
      }
      
      // === æ”¶è—é€»è¾‘ ===
      window.toggleFav = function(uid) {
          if (favoriteSet.has(uid)) {
              favoriteSet.delete(uid);
          } else {
              favoriteSet.add(uid);
          }
          localStorage.setItem("favorite_questions", JSON.stringify(Array.from(favoriteSet)));
          updateCounts();
          
          // å¦‚æœå½“å‰åœ¨æ”¶è—å¤¹æ¨¡å¼ä¸‹ï¼Œå–æ¶ˆæ”¶è—éœ€è¦åˆ·æ–°åˆ—è¡¨å—ï¼Ÿä¸ºäº†ä½“éªŒï¼Œæš‚æ—¶åªæ”¹å›¾æ ‡ï¼Œä¸å¼ºåˆ¶åˆ·æ–°
          // ä½†ä¸‹æ¬¡è¿›æ¥ä¼šæ¶ˆå¤±
          renderQ(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ˜Ÿæ˜ŸçŠ¶æ€
      };

      window.handleOpt = function (label) {
        const q = filteredList[curIndex];
        // è€ƒè¯•æ¨¡å¼ä¸‹å…è®¸åå¤ä¿®æ”¹ï¼Œç›´åˆ°äº¤å·ï¼›æ™®é€šæ¨¡å¼ä¸‹æäº¤åä¸å¯æ”¹
        if (!isExamMode && q.isSubmitted) return;

        const isMulti = (q.type && q.type.includes("å¤š")) || (q.answer && q.answer.length > 1);
        if (isMulti) {
          if (userSel.has(label)) userSel.delete(label);
          else userSel.add(label);
        } else {
          userSel.clear();
          userSel.add(label);
        }
        q.userSel = new Set(userSel);
        renderQ();
      };

      window.handleMainAction = function () {
        const q = filteredList[curIndex];
        if (q.isSubmitted) {
          move(1);
        } else {
          q.isSubmitted = true;
          
          if (q.type && q.type.includes("é€‰")) {
              const status = getQuestionStatus(q);
              if (status === 'wrong' || status === 'partial') {
                  if(!wrongSet.has(q._uid)) {
                      wrongSet.add(q._uid);
                      localStorage.setItem("wrong_questions", JSON.stringify(Array.from(wrongSet)));
                      updateCounts();
                  }
              }
          }

          if(['random_drill', 'wrong_book', 'favorites', 'mock_exam'].indexOf(curMod) === -1) {
              saveProgress();
              initSidebar();
              updateContinueBtn(); 
          }
          
          renderQ();
          
          // æ›´æ–°ä¸‹æ‹‰æ¡†çŠ¶æ€
          const status = getQuestionStatus(q);
          let mark = "";
          if (status === 'correct') mark = " âœ…";
          else if (status === 'partial') mark = " ğŸŒ—";
          else if (status === 'wrong') mark = " âŒ";

          const sel = document.getElementById("qJumper");
          if (sel.options[curIndex]) sel.options[curIndex].text += mark;
        }
      };

      window.removeFromWrongBook = function(uid) {
          if(confirm("ç¡®å®šå·²æŒæ¡è¿™é“é¢˜å¹¶å°†å…¶ç§»å‡ºé”™é¢˜æœ¬å—ï¼Ÿ")) {
              wrongSet.delete(uid);
              localStorage.setItem("wrong_questions", JSON.stringify(Array.from(wrongSet)));
              updateCounts();
              loadWrongBook(); 
          }
      };

      window.move = function (dir) {
        const next = curIndex + dir;
        if (next >= 0 && next < filteredList.length) {
          curIndex = next;
          renderQ();
        } else {
          if (dir === 1) alert("æœ¬åˆ—è¡¨é¢˜ç›®å·²ç»“æŸ");
        }
      };

      window.jumpTo = function (v) {
        curIndex = parseInt(v);
        renderQ();
      };

      window.toggleAns = function () {
        const p = document.getElementById("ansPanel");
        if (p) p.classList.toggle("show");
      };

      window.resetChapter = function () {
        if (!confirm(`ç¡®å®šè¦æ¸…ç©ºå½“å‰ç« èŠ‚çš„è¿›åº¦å—ï¼Ÿ`)) return;
        rawList.forEach((q) => {
          q.isSubmitted = false;
          q.userSel = new Set();
        });
        if(['random_drill', 'wrong_book', 'favorites', 'mock_exam'].indexOf(curMod) === -1) {
            saveProgress();
            loadChapter(curChapter);
        } else {
            renderQ(); 
        }
      };

      function saveProgress() {
        const state = rawList.map((q) => ({
          sel: Array.from(q.userSel),
          done: q.isSubmitted,
        }));
        localStorage.setItem(modules[curMod].prefix + curChapter, JSON.stringify(state));
      }

      window.toggleSidebar = function () {
        document.getElementById("sidebar").classList.toggle("open");
        document.getElementById("overlay").classList.toggle("active");
      };

      // === æš—é»‘æ¨¡å¼ ===
      function initDarkMode() {
          const isDark = localStorage.getItem("dark_mode") === "true";
          if(isDark) document.body.classList.add("dark-mode");
          updateDarkModeBtnText();
      }

      window.toggleDarkMode = function() {
          document.body.classList.toggle("dark-mode");
          const isDark = document.body.classList.contains("dark-mode");
          localStorage.setItem("dark_mode", isDark);
          updateDarkModeBtnText();
      }
      
      function updateDarkModeBtnText() {
          const isDark = document.body.classList.contains("dark-mode");
          document.getElementById("darkModeBtn").innerText = isDark ? "â˜€ï¸ æ—¥é—´æ¨¡å¼" : "ğŸŒ™ å¤œé—´æ¨¡å¼";
      }

      // === å¤‡ä»½ä¸æ¢å¤ ===
      window.exportData = function() {
          const data = {
              timestamp: new Date().toISOString(),
              store: {...localStorage}
          };
          const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `history_backup_${new Date().toISOString().slice(0,10)}.json`;
          a.click();
          URL.revokeObjectURL(url);
      }

      window.importData = function() {
          document.getElementById("fileInput").click();
      }

      window.handleFileImport = function(input) {
          const file = input.files[0];
          if(!file) return;
          const reader = new FileReader();
          reader.onload = function(e) {
              try {
                  const data = JSON.parse(e.target.result);
                  if(data.store) {
                      if(confirm(`æ£€æµ‹åˆ°å¤‡ä»½æ–‡ä»¶ (${data.timestamp})\næ˜¯å¦è¦†ç›–å½“å‰è¿›åº¦ï¼Ÿ`)) {
                          localStorage.clear();
                          Object.keys(data.store).forEach(k => {
                              localStorage.setItem(k, data.store[k]);
                          });
                          alert("æ¢å¤æˆåŠŸï¼Œé¡µé¢å°†åˆ·æ–°ã€‚");
                          location.reload();
                      }
                  } else {
                      alert("æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼");
                  }
              } catch(err) {
                  alert("æ–‡ä»¶è§£æå¤±è´¥");
              }
          };
          reader.readAsText(file);
          input.value = ""; // reset
      }

      // === AI ç›¸å…³ ===
      window.openAiSettings = function() {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("aiModal").style.display = "block";
        
        const provider = localStorage.getItem("ai_provider") || "gemini";
        document.getElementById("aiProvider").value = provider;
        document.getElementById("geminiKey").value = localStorage.getItem("ai_gemini_key") || "";
        document.getElementById("qwenKey").value = localStorage.getItem("ai_qwen_key") || "";
        document.getElementById("sfKey").value = localStorage.getItem("ai_sf_key") || "";
        document.getElementById("customUrl").value = localStorage.getItem("ai_custom_url") || "";
        document.getElementById("customKey").value = localStorage.getItem("ai_custom_key") || "";
        
        toggleAiInputs();
      }

      window.toggleAiInputs = function() {
        const type = document.getElementById("aiProvider").value;
        ['geminiConfig','qwenConfig','siliconFlowConfig','customConfig'].forEach(id => document.getElementById(id).style.display = 'none');
        if(type === 'gemini') document.getElementById('geminiConfig').style.display = 'block';
        else if (type === 'qwen') document.getElementById('qwenConfig').style.display = 'block';
        else if (type === 'siliconflow') document.getElementById('siliconFlowConfig').style.display = 'block';
        else document.getElementById('customConfig').style.display = 'block';
      }

      window.closeAll = function() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("aiModal").style.display = "none";
        document.getElementById("sidebar").classList.remove("open");
        document.getElementById("overlay").classList.remove("active");
      }

      window.saveAiSettings = function() {
        const provider = document.getElementById("aiProvider").value;
        localStorage.setItem("ai_provider", provider);
        
        if(provider === 'gemini') localStorage.setItem("ai_gemini_key", document.getElementById("geminiKey").value.trim());
        else if (provider === 'qwen') localStorage.setItem("ai_qwen_key", document.getElementById("qwenKey").value.trim());
        else if (provider === 'siliconflow') localStorage.setItem("ai_sf_key", document.getElementById("sfKey").value.trim());
        else {
            localStorage.setItem("ai_custom_url", document.getElementById("customUrl").value.trim());
            localStorage.setItem("ai_custom_key", document.getElementById("customKey").value.trim());
        }
        alert("é…ç½®å·²ä¿å­˜ï¼");
        closeAll();
      }

      window.askAI = async function() {
        const resultDiv = document.getElementById("aiResult");
        resultDiv.style.display = "block";
        resultDiv.innerHTML = "ğŸ¤– æ­£åœ¨æ€è€ƒä¸­...";
        
        const q = filteredList[curIndex];
        const prompt = `ä½ æ˜¯ä¸“ä¸šçš„å†å²è€å¸ˆã€‚è¯·è¯¦ç»†è§£æè¿™é“é¢˜ï¼Œè§£é‡Šä¸ºä»€ä¹ˆé€‰è¿™ä¸ªç­”æ¡ˆï¼Œä»¥åŠå…¶ä»–é€‰é¡¹ä¸ºä»€ä¹ˆé”™ã€‚
        é¢˜ç›®ï¼š${q.content}
        é€‰é¡¹ï¼š${JSON.stringify(q.options || [])}
        æ­£ç¡®ç­”æ¡ˆï¼š${q.answer}`;

        const provider = localStorage.getItem("ai_provider") || "gemini";
        
        try {
            let text = "";
            
            if (provider === 'gemini') {
                const apiKey = localStorage.getItem("ai_gemini_key");
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                const res = await fetch(url, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            } else if (provider === 'siliconflow') {
                const apiKey = localStorage.getItem("ai_sf_key");
                if(!apiKey) throw new Error("è¯·é…ç½®ç¡…åŸºæµåŠ¨API Key");
                const res = await fetch("https://api.siliconflow.cn/v1/chat/completions", {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "Qwen/Qwen2.5-72B-Instruct", messages: [{role:"user", content: prompt}] })
                });
                const data = await res.json();
                text = data.choices?.[0]?.message?.content;
            } else if (provider === 'qwen') {
                const apiKey = localStorage.getItem("ai_qwen_key") || BUILTIN_API_KEY;
                const res = await fetch("https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions", {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "qwen-turbo", messages: [{role:"user", content: prompt}] })
                });
                const data = await res.json();
                text = data.choices?.[0]?.message?.content;
            } else { // Custom
                const url = localStorage.getItem("ai_custom_url") + "/chat/completions";
                const key = localStorage.getItem("ai_custom_key");
                const res = await fetch(url, {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${key}` },
                    body: JSON.stringify({ model: "gpt-3.5-turbo", messages: [{role:"user", content: prompt}] })
                });
                const data = await res.json();
                text = data.choices?.[0]?.message?.content;
            }
            
            resultDiv.innerHTML = (text || "æ— å†…å®¹").replace(/\n/g, "<br>").replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
        } catch(e) {
            resultDiv.innerHTML = `<span style="color:red">è¯·æ±‚å¤±è´¥: ${e.message}</span>`;
        }
      }

      window.copyPrompt = function() {
        const q = filteredList[curIndex];
        const prompt = `è¯·è§£æå†å²é¢˜ï¼š${q.content}ã€‚é€‰é¡¹ï¼š${JSON.stringify(q.options || []).replace(/"/g, '')}ã€‚ç­”æ¡ˆï¼š${q.answer}`;
        navigator.clipboard.writeText(prompt).then(() => alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"));
      }
    </script>
  </body>
</html>
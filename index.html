<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>è¿‘ç°ä»£å² - æ™ºèƒ½å¤ä¹ ç³»ç»Ÿ V14.6 (ç²¾å‡†åˆ¤åˆ†ç‰ˆ)</title>
    <style>
      :root {
        --primary: #4f46e5;
        --primary-light: #eef2ff;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --text-main: #1f2937;
        --bg-color: #f8fafc;
        --sidebar-width: 280px;
        --safe-bottom: env(safe-area-inset-bottom, 20px);
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, "PingFang SC", sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        height: 100vh;
        display: flex;
        overflow: hidden;
      }

      /* === ä¾§è¾¹æ  === */
      .sidebar {
        width: var(--sidebar-width);
        background: white;
        border-right: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
        z-index: 50;
        transition: transform 0.3s;
        flex-shrink: 0;
      }

      .sidebar-header {
        padding: 20px;
        background: white;
        border-bottom: 1px solid #f1f5f9;
      }

      .app-brand {
        font-size: 1.2rem;
        font-weight: 800;
        color: var(--primary);
        text-align: center;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .mod-tabs {
        display: flex;
        background: #f1f5f9;
        padding: 4px;
        border-radius: 8px;
      }
      .mod-tab {
        flex: 1;
        border: none;
        background: none;
        padding: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #64748b;
        cursor: pointer;
        border-radius: 6px;
        transition: 0.2s;
      }
      .mod-tab.active {
        background: white;
        color: var(--primary);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .chapter-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .chapter-item {
        padding: 12px;
        margin-bottom: 6px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #475569;
        transition: 0.2s;
        border: 1px solid transparent;
      }
      .chapter-item:hover {
        background: var(--primary-light);
      }
      .chapter-item.active {
        background: var(--primary-light);
        color: var(--primary);
        border-color: #c7d2fe;
        font-weight: 600;
      }

      .badge-pill {
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 10px;
        background: #e2e8f0;
        color: #64748b;
      }
      .chapter-item.active .badge-pill {
        background: white;
        color: var(--primary);
      }

      /* === ä¸»å†…å®¹åŒº === */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
        background: var(--bg-color);
        position: relative;
        min-width: 0;
      }

      /* é¡¶éƒ¨å¯¼èˆª */
      .top-nav {
        background: white;
        padding: 10px 15px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 20;
      }

      .nav-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .menu-toggle {
        font-size: 1.5rem;
        background: none;
        border: none;
        color: #475569;
        cursor: pointer;
        display: none;
        margin-right: 10px;
      }

      .nav-title {
        font-weight: 700;
        font-size: 1rem;
        color: #0f172a;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }

      .jump-box {
        padding: 4px 8px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        font-size: 0.85rem;
        color: #475569;
        outline: none;
        background: white;
        max-width: 100px;
      }

      /* ç­›é€‰å™¨ */
      .filter-scroll {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 2px;
        scrollbar-width: none; /* Firefox */
      }
      .filter-scroll::-webkit-scrollbar {
        display: none; /* Chrome/Safari */
      }

      .filter-chip {
        padding: 5px 12px;
        border-radius: 20px;
        background: white;
        border: 1px solid #e2e8f0;
        color: #64748b;
        font-size: 0.8rem;
        white-space: nowrap;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .filter-chip:hover {
        border-color: #cbd5e1;
      }
      .filter-chip.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
      }

      /* å†…å®¹æ»šåŠ¨åŒº */
      .content-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        justify-content: center;
      }

      .card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        padding: 25px;
        width: 100%;
        max-width: 800px;
        height: fit-content;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
      }

      /* çŸ¥è¯†ç‚¹å¡ç‰‡ç‰¹æ®Šæ ·å¼ */
      .card.knowledge-mode {
        border-left: 5px solid var(--warning);
        background: #fffbeb;
      }
      .card.knowledge-mode .q-type {
        background: var(--warning);
        color: white;
      }

      /* ææ–™é¢˜ç‰¹æ®Šæ ·å¼ */
      .card.material-mode {
        border-left: 5px solid #8b5cf6;
      }

      /* é”™é¢˜æ¨¡å¼ç‰¹æ®Šæ ·å¼ */
      .card.wrong-mode {
        border-left: 5px solid #e11d48;
      }

      .q-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        align-items: center;
      }

      .q-type {
        font-size: 0.75rem;
        padding: 3px 8px;
        border-radius: 6px;
        font-weight: 700;
        background: #f1f5f9;
        color: #64748b;
        letter-spacing: 0.5px;
      }

      .q-content {
        font-size: 1.15rem;
        line-height: 1.7;
        color: #1e293b;
        margin-bottom: 25px;
        white-space: pre-wrap;
      }

      /* é€‰é¡¹ */
      .opts-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .opt-row {
        display: flex;
        padding: 15px;
        border: 2px solid #f1f5f9;
        border-radius: 12px;
        cursor: pointer;
        background: white;
        transition: 0.15s;
        align-items: flex-start;
      }
      .opt-row:hover {
        border-color: #cbd5e1;
      }
      .opt-row.selected {
        border-color: var(--primary);
        background: var(--primary-light);
      }
      .opt-row.correct {
        border-color: var(--success);
        background: #d1fae5;
      }
      .opt-row.wrong {
        border-color: var(--error);
        background: #fee2e2;
      }
      
      /* æ¼é€‰æ ·å¼ï¼ˆæ­£ç¡®ç­”æ¡ˆä½†æ²¡é€‰ï¼‰ */
      .opt-row.missed {
        border-color: var(--warning);
        background: #fffbeb;
        border-style: dashed;
      }

      .opt-idx {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #f1f5f9;
        color: #64748b;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        margin-right: 12px;
        flex-shrink: 0;
      }
      .opt-row.selected .opt-idx {
        background: var(--primary);
        color: white;
      }
      .opt-row.correct .opt-idx {
        background: var(--success);
        color: white;
      }
      .opt-row.wrong .opt-idx {
        background: var(--error);
        color: white;
      }
      .opt-row.missed .opt-idx {
        background: var(--warning);
        color: white;
      }

      /* ç­”æ¡ˆä¸è§£æ */
      .answer-section {
        margin-top: 25px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
        display: none;
        border: 1px solid #e2e8f0;
      }
      .answer-section.show {
        display: block;
        animation: slideDown 0.3s;
      }
      
      /* åˆ¤åˆ†çŠ¶æ€å¾½ç«  */
      .status-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: bold;
        margin-bottom: 15px;
      }
      .status-correct { background: #d1fae5; color: #059669; border: 1px solid #6ee7b7; }
      .status-partial { background: #fffbeb; color: #d97706; border: 1px solid #fcd34d; }
      .status-wrong { background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; }

      /* AI ç›¸å…³æ ·å¼ */
      .ai-btn {
        margin-top: 15px;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: 0.2s;
        font-weight: 600;
        box-shadow: 0 2px 5px rgba(99, 102, 241, 0.3);
      }
      .ai-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(99, 102, 241, 0.4);
      }
      .ai-result {
        margin-top: 15px;
        padding: 15px;
        background: #ffffff;
        border: 1px solid #c7d2fe;
        border-radius: 8px;
        font-size: 0.95rem;
        line-height: 1.6;
        color: #334155;
        display: none;
        position: relative;
      }
      .ai-result.loading::before {
        content: "ğŸ¤– æ­£åœ¨æ€è€ƒä¸­...";
        color: #6366f1;
        font-style: italic;
      }

      /* åº•éƒ¨æ“ä½œæ  */
      .action-bar {
        background: white;
        border-top: 1px solid #e2e8f0;
        padding: 12px 20px;
        padding-bottom: max(12px, var(--safe-bottom));
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }
      .btn:active {
        transform: scale(0.98);
      }
      .btn-secondary {
        background: #f1f5f9;
        color: #475569;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
        flex: 2;
        box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2);
      }
      .btn-knowledge {
        background: var(--warning);
        color: white;
        flex: 2;
        box-shadow: 0 4px 10px rgba(245, 158, 11, 0.2);
      }
      .btn-wrong {
        background: #e11d48;
        color: white;
        flex: 2;
        box-shadow: 0 4px 10px rgba(225, 29, 72, 0.2);
      }

      .tool-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 20px;
      }
      .text-link {
        font-size: 0.85rem;
        color: #64748b;
        cursor: pointer;
        text-decoration: underline;
        background: none;
        border: none;
      }

      /* æ¨¡å¼åˆ‡æ¢åŒº */
      .mode-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 15px;
      }
      .mod-row {
        display: flex;
        background: #f1f5f9;
        padding: 3px;
        border-radius: 8px;
      }
      .mod-tab {
        flex: 1;
        border: none;
        background: none;
        padding: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #64748b;
        cursor: pointer;
        border-radius: 6px;
        transition: 0.2s;
        white-space: nowrap;
      }
      .mod-tab.active {
        background: white;
        color: var(--primary);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      /* ç‰¹æ®Šæ¨¡å¼æŒ‰é’® */
      .special-btn {
        background: #fff1f2;
        color: #e11d48;
      }
      .special-btn.active {
        background: #e11d48;
        color: white;
      }
      .random-btn {
        background: #f0fdf4;
        color: #15803d;
      }
      .random-btn.active {
        background: #15803d;
        color: white;
      }

      /* é®ç½©ä¸æ¨¡æ€æ¡† */
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 45;
        display: none;
      }
      
      .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 25px;
        border-radius: 16px;
        width: 90%;
        max-width: 400px;
        z-index: 100;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        display: none;
      }
      .modal h3 { margin-top: 0; color: var(--text-main); }
      
      .form-group { margin-bottom: 15px; }
      .form-label { display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 5px; }
      .form-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.95rem;
      }
      
      .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

      /* ç§»é™¤æŒ‰é’® */
      .remove-wrong-btn {
        background: #fff1f2;
        color: #e11d48;
        border: 1px solid #fecdd3;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        cursor: pointer;
        margin-top: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .remove-wrong-btn:hover { background: #ffe4e6; }

      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          left: -100%;
          height: 100%;
          width: 85%;
          box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
        }
        .sidebar.open {
          left: 0;
        }
        .menu-toggle {
          display: block;
        }
        .overlay.active {
          display: block;
        }
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="app-brand">âš¡ï¸ å†å²å¤ä¹ ç³»ç»Ÿ</div>
        
        <!-- æ¨¡å¼é€‰æ‹©åŒº -->
        <div class="mode-group">
            <div class="mod-row">
                <button class="mod-tab active" onclick="switchModule('postgrad')" id="tab-pg">ğŸ“š è€ƒç ”çœŸé¢˜</button>
                <button class="mod-tab" onclick="switchModule('history')" id="tab-hist">ğŸ“ è¯¾åç»ƒä¹ </button>
            </div>
            <div class="mod-row">
                <button class="mod-tab special-btn" onclick="switchModule('wrong_book')" id="tab-wrong">âŒ é”™é¢˜é›†</button>
                <button class="mod-tab random-btn" onclick="switchModule('random_drill')" id="tab-random">ğŸ”€ ä¹±åºåˆ·é¢˜</button>
            </div>
        </div>
      </div>
      <div class="chapter-list" id="chapterList"></div>
      
      <!-- åº•éƒ¨å·¥å…·åŒº -->
      <div
        style="padding: 15px; border-top: 1px solid #f1f5f9; display: flex; flex-direction: column; gap: 10px;"
      >
        <button
          onclick="openAiSettings()"
          style="
            color: var(--primary);
            background: #eef2ff;
            border: 1px solid #c7d2fe;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex; align-items: center; justify-content: center; gap: 6px;
          "
        >
          âš™ï¸ AI è®¾ç½®
        </button>
        <button
          onclick="resetChapter()"
          style="
            color: #ef4444;
            background: white;
            border: 1px solid #fee2e2;
            padding: 6px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
          "
        >
          ğŸ—‘ï¸ æ¸…ç©ºå½“å‰è¿›åº¦
        </button>
      </div>
    </div>
    <div class="overlay" id="overlay" onclick="closeAll()"></div>

    <!-- API è®¾ç½®å¼¹çª— -->
    <div class="modal" id="aiModal">
      <h3>é…ç½® AI æœåŠ¡</h3>
      
      <div class="form-group">
        <label class="form-label">é€‰æ‹©æœåŠ¡å•†</label>
        <select class="form-input" id="aiProvider" onchange="toggleAiInputs()">
          <option value="gemini">Google Gemini</option>
          <option value="qwen">é€šä¹‰çµç  (é˜¿é‡Œäº‘ DashScope)</option>
          <option value="siliconflow">é€šä¹‰åƒé—® (ç¡…åŸºæµåŠ¨ - é˜²è·¨åŸŸå¤‡ç”¨)</option>
          <option value="custom">å…¶ä»– (è±†åŒ…/DeepSeek/Custom)</option>
        </select>
      </div>

      <!-- Gemini é…ç½® -->
      <div id="geminiConfig">
        <div class="form-group">
          <label class="form-label">é€‰æ‹©æ¨¡å‹ç‰ˆæœ¬</label>
          <select class="form-input" id="geminiModel">
            <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (æ¨è)</option>
            <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">API Key</label>
          <input type="password" id="geminiKey" class="form-input" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨å†…ç½®Key" />
          <div style="font-size:0.8rem; margin-top:5px; color:#64748b">
            ç•™ç©ºå°†è‡ªåŠ¨ä½¿ç”¨å†…ç½®çš„å…è´¹Keyï¼Œä¹Ÿå¯å¡«å…¥ä½ è‡ªå·±çš„Keyã€‚
          </div>
        </div>
      </div>

      <!-- é€šä¹‰çµç /é˜¿é‡Œäº‘ (Qwen) é…ç½® -->
      <div id="qwenConfig" style="display:none">
        <div class="form-group">
            <label class="form-label">API Key (é€šä¹‰çµç /é˜¿é‡Œäº‘)</label>
            <input type="password" id="qwenKey" class="form-input" placeholder="sk-..." />
            <div style="font-size:0.8rem; margin-top:5px; color:#64748b">
              å¡«å…¥ä½ è‡ªå·±çš„ DashScope Keyï¼Œæˆ–è€…ç•™ç©ºå°è¯•ä½¿ç”¨å†…ç½®Keyã€‚
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">é€‰æ‹©æ¨¡å‹</label>
            <select class="form-input" id="qwenModel">
              <option value="qwen-turbo">qwen-turbo (æ ‡å‡†ç‰ˆ)</option>
              <option value="qwen-plus">qwen-plus (å¢å¼ºç‰ˆ)</option>
              <option value="qwen-max">qwen-max (æ——èˆ°ç‰ˆ)</option>
            </select>
        </div>
      </div>

      <!-- ç¡…åŸºæµåŠ¨ (SiliconFlow) é…ç½® -->
      <div id="siliconFlowConfig" style="display:none">
        <div class="form-group">
            <label class="form-label">API Key (ç¡…åŸºæµåŠ¨)</label>
            <input type="password" id="sfKey" class="form-input" placeholder="sk-..." />
            <div style="font-size:0.8rem; margin-top:5px;">
              <a href="https://cloud.siliconflow.cn/i/sDwG8Q6x" target="_blank" style="color:var(--primary)">ğŸ‘‰ æ³¨å†Œ SiliconCloud (å…è´¹ Qwen)</a>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">é€‰æ‹©æ¨¡å‹</label>
            <select class="form-input" id="sfModel">
              <option value="Qwen/Qwen2.5-7B-Instruct">Qwen 2.5 7B (å…è´¹)</option>
              <option value="Qwen/Qwen2.5-72B-Instruct">Qwen 2.5 72B (æ¨è)</option>
              <option value="deepseek-ai/DeepSeek-V3">DeepSeek V3</option>
            </select>
        </div>
      </div>

      <!-- è‡ªå®šä¹‰ é…ç½® -->
      <div id="customConfig" style="display:none">
        <div class="form-group">
          <label class="form-label">API Base URL</label>
          <input type="text" id="customUrl" class="form-input" placeholder="https://api..." />
        </div>
        <div class="form-group">
          <label class="form-label">API Key</label>
          <input type="password" id="customKey" class="form-input" />
        </div>
        <div class="form-group">
          <label class="form-label">Model Name</label>
          <input type="text" id="customModel" class="form-input" />
        </div>
      </div>

      <div class="modal-btns">
        <button class="btn btn-secondary" onclick="closeAll()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveAiSettings()">ä¿å­˜é…ç½®</button>
      </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div class="main-content">
      <div class="top-nav">
        <div class="nav-row">
          <div style="display: flex; align-items: center; overflow: hidden">
            <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
            <div class="nav-title" id="headerTitle">è¯·é€‰æ‹©ç« èŠ‚</div>
          </div>
          <select
            class="jump-box"
            id="qJumper"
            onchange="jumpTo(this.value)"
            disabled
          >
            <option>ç¬¬ 0/0 é¢˜</option>
          </select>
        </div>

        <div class="filter-scroll" id="filterBar">
          <button class="filter-chip active" onclick="setFilter('all')">
            â™¾ï¸ å…¨éƒ¨
          </button>
          <button class="filter-chip" onclick="setFilter('çŸ¥è¯†ç‚¹')">
            ğŸ’¡ çŸ¥è¯†ç‚¹
          </button>
          <button class="filter-chip" onclick="setFilter('å•é€‰')">
            ğŸ”´ å•é€‰é¢˜
          </button>
          <button class="filter-chip" onclick="setFilter('å¤šé€‰')">
            ğŸ”µ å¤šé€‰é¢˜
          </button>
          <button class="filter-chip" onclick="setFilter('ç®€ç­”')">
            ğŸŸ¢ ç®€ç­”é¢˜
          </button>
          <button class="filter-chip" onclick="setFilter('ææ–™')">
            ğŸ“œ ææ–™é¢˜
          </button>
        </div>
      </div>

      <div class="content-area" id="qContainer">
        <div style="text-align: center; margin-top: 100px; color: #94a3b8">
          <div style="font-size: 3rem; margin-bottom: 10px">ğŸ‘ˆ</div>
          è¯·åœ¨å·¦ä¾§ç›®å½•é€‰æ‹©æ¨¡å¼å¼€å§‹å¤ä¹ 
        </div>
      </div>

      <div class="tool-row">
        <button class="text-link" onclick="toggleAns()">
          ğŸ‘ï¸ æ˜¾ç¤º/éšè—ç­”æ¡ˆ
        </button>
        <span id="scoreText" style="font-size: 0.85rem; color: #64748b"></span>
      </div>

      <div class="action-bar">
        <button class="btn btn-secondary" onclick="move(-1)">â¬…ï¸ ä¸Šä¸€é¢˜</button>
        <button
          class="btn btn-primary"
          id="mainBtn"
          onclick="handleMainAction()"
        >
          âœ… æäº¤ç­”æ¡ˆ
        </button>
        <button class="btn btn-secondary" onclick="move(1)">ä¸‹ä¸€é¢˜ â¡ï¸</button>
      </div>
    </div>

    <script>
      // === é…ç½®ä¸çŠ¶æ€ ===
      const modules = {
        postgrad: { name: "è€ƒç ”çœŸé¢˜", data: [], prefix: "pg_" },
        history: { name: "è¯¾åç»ƒä¹ ", data: [], prefix: "hist_" },
        // è™šæ‹Ÿæ¨¡å—
        wrong_book: { name: "é”™é¢˜é›†", data: [], prefix: "wb_" },
        random_drill: { name: "ä¹±åºåˆ·é¢˜", data: [], prefix: "rd_" }
      };

      // å†…ç½®çš„é€šä¹‰çµç  API Key
      const BUILTIN_API_KEY = "sk-60ffb14cd765472bb2de892c632ad0dc";

      let curMod = localStorage.getItem("last_mod") || "postgrad";
      let allData = [];
      let curChapter = "";
      let rawList = []; 
      let filteredList = [];
      let curIndex = 0; 
      let filterType = "all";
      let userSel = new Set(); 
      let wrongSet = new Set(); // å­˜å‚¨é”™é¢˜ID

      // === åˆå§‹åŒ– ===
      window.onload = async () => {
        try {
          // åŠ è½½é”™é¢˜è®°å½•
          const savedWrongs = localStorage.getItem("wrong_questions");
          if (savedWrongs) wrongSet = new Set(JSON.parse(savedWrongs));

          const [res1, res2] = await Promise.allSettled([
            fetch("./questions.json").then((r) => r.json()),
            fetch("./history_questions.json").then((r) => r.json()),
          ]);

          modules.postgrad.data = frontendRepair(
            res1.status === "fulfilled" ? res1.value : []
          );
          modules.history.data = frontendRepair(
            res2.status === "fulfilled" ? res2.value : []
          );

          // ä¸ºæ‰€æœ‰é¢˜ç›®ç”Ÿæˆå”¯ä¸€IDï¼Œç”¨äºé”™é¢˜è¿½è¸ª
          assignIds(modules.postgrad.data, "pg");
          assignIds(modules.history.data, "hist");

          switchModule(curMod);
        } catch (e) {
          console.error(e);
          alert(
            "åŠ è½½å¤±è´¥ï¼šè¯·ç¡®ä¿ä½¿ç”¨ python -m http.server è¿è¡Œï¼Œå¹¶ä¿è¯JSONæ–‡ä»¶å­˜åœ¨ã€‚"
          );
        }
      };

      // ç”Ÿæˆå”¯ä¸€ID
      function assignIds(data, prefix) {
        if (!data) return;
        data.forEach((q, idx) => {
            const str = q.chapter + q.content.substring(0,10);
            let hash = 0;
            for(let i=0; i<str.length; i++) hash = (hash<<5) - hash + str.charCodeAt(i);
            q._uid = `${prefix}_${Math.abs(hash)}_${idx}`;
        });
      }

      function frontendRepair(data) {
        if (!data) return [];
        return data.map((q) => {
          if (q.type === "çŸ¥è¯†ç‚¹") return q;
          if (q.type.includes("é€‰") && (!q.options || q.options.length === 0)) {
            const parts = q.content.split(/\s(?=[A-E][\.ï¼ã€])/);
            if (parts.length > 1) {
              q.content = parts[0]; 
              q.options = [];
              for (let i = 1; i < parts.length; i++) {
                const t = parts[i].trim();
                q.options.push({
                  label: t.charAt(0),
                  text: t.substring(1).replace(/^[\.ï¼ã€]/, "").trim(),
                });
              }
            }
          }
          return q;
        });
      }

      // === æ¨¡å—é€»è¾‘ ===
      function switchModule(key) {
        curMod = key;
        localStorage.setItem("last_mod", key);

        // æ›´æ–°UIæŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.mod-tab').forEach(btn => btn.classList.remove('active'));
        if(key === 'wrong_book') document.getElementById('tab-wrong').classList.add('active');
        else if(key === 'random_drill') document.getElementById('tab-random').classList.add('active');
        else if(key === 'postgrad') document.getElementById('tab-pg').classList.add('active');
        else document.getElementById('tab-hist').classList.add('active');

        // å¤„ç†ç‰¹æ®Šæ¨¡å¼
        if (key === 'wrong_book') {
            loadWrongBook();
        } else if (key === 'random_drill') {
            loadRandomDrill();
        } else {
            allData = modules[key].data;
            curChapter = "";
            rawList = [];
            filteredList = [];
            initSidebar(); // æ¢å¤æ­£å¸¸ç« èŠ‚ä¾§è¾¹æ 
            document.getElementById("qContainer").innerHTML = 
                `<div style="text-align:center; margin-top:100px; color:#94a3b8;">ğŸ“‚ å·²åˆ‡æ¢è‡³ ${modules[key].name}<br>è¯·åœ¨å·¦ä¾§é€‰æ‹©ç« èŠ‚</div>`;
            document.getElementById("headerTitle").innerText = "è¯·é€‰æ‹©ç« èŠ‚";
            document.getElementById("qJumper").disabled = true;
        }
      }

      // åŠ è½½é”™é¢˜æœ¬
      function loadWrongBook() {
        const pool = [...modules.postgrad.data, ...modules.history.data];
        rawList = pool.filter(q => wrongSet.has(q._uid));
        
        document.getElementById("chapterList").innerHTML = 
            `<div style="padding:15px; color:#64748b; text-align:center">
                å…±æ”¶é›†é”™é¢˜ <strong>${rawList.length}</strong> é“
             </div>`;
        
        curChapter = "é”™é¢˜æœ¬";
        setFilter('all');
        
        if(rawList.length === 0) {
            document.getElementById("qContainer").innerHTML = 
                `<div style="text-align:center; margin-top:100px; color:#10b981;">ğŸ‰ å¤ªæ£’äº†ï¼é”™é¢˜æœ¬æ˜¯ç©ºçš„ï¼<br>å¿«å»åˆ·é¢˜å§~</div>`;
        }
      }

      // åŠ è½½ä¹±åºåˆ·é¢˜
      function loadRandomDrill() {
        // æå–æ‰€æœ‰é€‰æ‹©é¢˜
        let pool = [...modules.postgrad.data, ...modules.history.data]
            .filter(q => q.type && q.type.includes("é€‰"));
        
        // Fisher-Yates æ´—ç‰Œ
        for (let i = pool.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [pool[i], pool[j]] = [pool[j], pool[i]];
        }
        
        rawList = pool;
        document.getElementById("chapterList").innerHTML = 
            `<div style="padding:15px; color:#64748b; text-align:center">
                å…¨åº“ä¹±åºæ¨¡å¼<br>å…± <strong>${rawList.length}</strong> é“é€‰æ‹©é¢˜
             </div>`;
        
        curChapter = "ä¹±åºåˆ·é¢˜";
        // é‡ç½®è¿™äº›é¢˜ç›®çš„ä¸´æ—¶çŠ¶æ€ï¼ˆä¸ä¿å­˜è¿›åº¦ï¼Œæ¯æ¬¡éƒ½æ˜¯æ–°çš„ï¼‰
        rawList.forEach(q => {
            q.userSel = new Set();
            q.isSubmitted = false;
        });
        
        setFilter('all');
      }

      function initSidebar() {
        const list = document.getElementById("chapterList");
        list.innerHTML = "";

        const map = new Map();
        allData.forEach((q) => {
            if (!map.has(q.chapter)) map.set(q.chapter, 0);
            map.set(q.chapter, map.get(q.chapter) + 1);
        });

        map.forEach((total, cName) => {
            const key = modules[curMod].prefix + cName;
            const saved = JSON.parse(localStorage.getItem(key) || "[]");
            const done = saved.filter((x) => x && x.done).length;

            const div = document.createElement("div");
            div.className = "chapter-item";
            if (cName === curChapter) div.classList.add("active");
            div.innerHTML = `<span>${cName}</span><span class="badge-pill">${done}/${total}</span>`;
            div.onclick = () => loadChapter(cName);
            list.appendChild(div);
        });
      }

      // === ç« èŠ‚ä¸ç­›é€‰ ===
      function loadChapter(cName) {
        curChapter = cName;
        rawList = allData.filter((q) => q.chapter === cName);

        const key = modules[curMod].prefix + cName;
        const saved = JSON.parse(localStorage.getItem(key) || "[]");
        
        // å…³é”®ä¿®å¤ï¼šåŠ è½½ç« èŠ‚æ—¶åŒæ­¥isSubmittedçŠ¶æ€å’Œç”¨æˆ·çš„é€‰æ‹©
        rawList.forEach((q, i) => {
          if (saved[i]) {
            q.userSel = new Set(saved[i].sel || []);
            q.isSubmitted = saved[i].done || false;
          } else {
            q.userSel = new Set();
            q.isSubmitted = false;
          }
        });

        setFilter(filterType);
        initSidebar();
        if (window.innerWidth <= 768) {
             document.getElementById("sidebar").classList.remove("open");
             document.getElementById("overlay").classList.remove("active");
        }
      }

      // æ ¸å¿ƒåˆ¤åˆ†é€»è¾‘ (Extract Logic for Reuse)
      function getQuestionStatus(q) {
          if (!q.isSubmitted) return 'none';
          if (q.type === 'çŸ¥è¯†ç‚¹') return 'correct';
          
          // å¯¹äºç®€ç­”é¢˜ã€ææ–™é¢˜ç­‰ä¸»è§‚é¢˜ï¼Œé»˜è®¤è§†ä¸ºâ€œå®Œæˆâ€å³â€œæ­£ç¡®â€
          if (!q.options || q.options.length === 0) return 'correct'; 

          const correctArr = (q.answer || "").toUpperCase().split("").filter(c => /[A-Z]/.test(c));
          const correctSet = new Set(correctArr);
          const userSet = q.userSel || new Set();

          // 1. æ£€æŸ¥æ˜¯å¦æœ‰é”™é€‰
          let hasWrong = false;
          for (let s of userSet) {
              if (!correctSet.has(s)) {
                  hasWrong = true;
                  break;
              }
          }

          if (hasWrong) return 'wrong';
          
          // 2. æ£€æŸ¥æ˜¯å¦å…¨å¯¹
          if (userSet.size === correctSet.size) return 'correct';
          
          // 3. æ²¡é€‰é”™ï¼Œä½†æ²¡é€‰å…¨ -> åŠå¯¹
          if (userSet.size > 0 && userSet.size < correctSet.size) return 'partial';
          
          // 4. ä¸€ä¸ªæ²¡é€‰ï¼ˆæäº¤äº†ç™½å·ï¼‰ï¼Œè§†ä¸ºé”™
          if (userSet.size === 0 && correctSet.size > 0) return 'wrong';
          
          return 'correct'; // Fallback
      }

      function setFilter(type) {
        filterType = type;
        document.querySelectorAll(".filter-chip").forEach((b) => {
          b.className = b.innerText.includes(type === "all" ? "å…¨éƒ¨" : type)
            ? "filter-chip active"
            : "filter-chip";
        });

        if (type === "all") filteredList = rawList;
        else
          filteredList = rawList.filter((q) => q.type && q.type.includes(type));

        const sel = document.getElementById("qJumper");
        sel.innerHTML = "";
        if (filteredList.length === 0) {
          sel.disabled = true;
          document.getElementById(
            "qContainer"
          ).innerHTML = `<div style="text-align:center;margin-top:50px;color:#999">æ²¡æœ‰æ­¤ç±»é¢˜ç›®</div>`;
          return;
        }

        sel.disabled = false;
        filteredList.forEach((q, i) => {
          // ä¿®å¤ï¼šæ ¹æ®åˆ¤åˆ†çŠ¶æ€æ˜¾ç¤ºä¸åŒæ ‡è®°
          const status = getQuestionStatus(q);
          let mark = "";
          if (status === 'correct') mark = " âœ…";
          else if (status === 'partial') mark = " ğŸŒ—";
          else if (status === 'wrong') mark = " âŒ";

          sel.add(
            new Option(
              `${i + 1}. ${shorten(q.content)}${mark}`,
              i
            )
          );
        });

        // è‡ªåŠ¨è·³è½¬åˆ°æ²¡åšè¿‡çš„é¢˜
        let next = filteredList.findIndex((q) => !q.isSubmitted);
        curIndex = next === -1 ? 0 : next;
        renderQ();
      }

      function shorten(s) {
        return s.length > 8 ? s.substring(0, 8) + "..." : s;
      }

      // === æ¸²æŸ“æ ¸å¿ƒ ===
      function renderQ() {
        if (!filteredList.length) return;
        const q = filteredList[curIndex];

        document.getElementById("headerTitle").innerText = curChapter;
        document.getElementById("qJumper").value = curIndex;
        userSel = new Set(q.userSel);

        const container = document.getElementById("qContainer");

        let cardClass = "card";
        let btnText = "âœ… æäº¤ç­”æ¡ˆ";
        let btnClass = "btn btn-primary";

        if (curMod === 'wrong_book') {
            cardClass += " wrong-mode";
        } else if (q.type === "çŸ¥è¯†ç‚¹") {
            cardClass += " knowledge-mode";
            btnText = q.isSubmitted ? "å·²èƒŒç†Ÿ" : "ğŸ‘Œ è®°ä½äº†";
            btnClass = "btn btn-knowledge";
        } else if (q.type === "ææ–™é¢˜") {
            cardClass += " material-mode";
        }

        if (q.isSubmitted && q.type !== "çŸ¥è¯†ç‚¹") {
          btnText =
            curIndex < filteredList.length - 1 ? "ä¸‹ä¸€é¢˜ â¡ï¸" : "å®Œæˆæœ¬ç« ";
        }

        const mBtn = document.getElementById("mainBtn");
        mBtn.innerText = btnText;
        mBtn.className = btnClass;

        let bodyHtml = "";
        
        // åˆ¤åˆ†å¹¶ç”ŸæˆçŠ¶æ€Badge (ç•Œé¢æ˜¾ç¤º)
        let statusBadge = "";
        if(q.isSubmitted && q.type !== "çŸ¥è¯†ç‚¹" && q.type !== "ææ–™é¢˜" && q.type !== "ç®€ç­”é¢˜") {
            const status = getQuestionStatus(q);
            if(status === "wrong") {
                statusBadge = `<div class="status-badge status-wrong">âŒ å›ç­”é”™è¯¯</div>`;
            } else if (status === "partial") {
                statusBadge = `<div class="status-badge status-partial">âš ï¸ æ¼é€‰ï¼ˆç®—åŠå¯¹ï¼‰</div>`;
            } else {
                statusBadge = `<div class="status-badge status-correct">âœ… å›ç­”æ­£ç¡®</div>`;
            }
        }

        if (q.type === "çŸ¥è¯†ç‚¹") {
          bodyHtml = `<div style="font-size:1.1rem; line-height:1.8; color:#b45309;">${q.content}</div>`;
        } else if (q.options && q.options.length > 0) {
          bodyHtml = `<div class="opts-container">
              ${q.options
                .map((opt) => {
                  let cls = "opt-row";
                  const correctSet = new Set((q.answer || "").toUpperCase().split(""));
                  
                  if (q.isSubmitted) {
                    if (correctSet.has(opt.label)) {
                        cls += " correct"; // æ­£ç¡®ç­”æ¡ˆé¡¹
                        if (!userSel.has(opt.label)) cls += " missed"; // æ¼é€‰é¡¹
                    } else if (userSel.has(opt.label)) {
                        cls += " wrong"; // é”™é€‰é¡¹
                    }
                  } else {
                    if (userSel.has(opt.label)) cls += " selected";
                  }
                  return `
                 <div class="${cls}" onclick="handleOpt('${opt.label}')">
                   <div class="opt-idx">${opt.label}</div>
                   <div style="flex:1">${opt.text}</div>
                 </div>`;
                })
                .join("")}
            </div>`;
        } else if (q.type === "ææ–™é¢˜" || q.type === "ç®€ç­”é¢˜") {
          bodyHtml = `<div style="padding:15px; background:#f1f5f9; border-radius:8px; color:#64748b; font-style:italic">
              (è¯·åœ¨å¿ƒä¸­ä½œç­”ï¼Œç„¶åç‚¹å‡»æäº¤æŸ¥çœ‹å‚è€ƒç­”æ¡ˆ)
            </div>`;
        } else {
          bodyHtml = `<div style="color:red">æ— æ³•è¯†åˆ«é€‰é¡¹ï¼Œè¯·æŸ¥çœ‹ç­”æ¡ˆã€‚</div>`;
        }

        // æ„å»ºåŠŸèƒ½åŒº
        const showAiBtn = q.isSubmitted && q.type !== "çŸ¥è¯†ç‚¹";
        // åªæœ‰åœ¨é”™é¢˜æœ¬æ¨¡å¼ï¼Œä¸”å·²ç»æäº¤ç­”æ¡ˆæ—¶ï¼Œæ˜¾ç¤ºç§»é™¤æŒ‰é’®
        const showRemoveBtn = curMod === 'wrong_book'; 

        container.innerHTML = `
          <div class="${cardClass}">
             <div class="q-header">
                <span class="q-type">${q.type || "é¢˜ç›®"}</span>
                <span style="font-size:0.8rem; color:#94a3b8">${
                  curIndex + 1
                } / ${filteredList.length}</span>
             </div>
             ${
               q.type !== "çŸ¥è¯†ç‚¹"
                 ? `<div class="q-content">${q.content}</div>`
                 : ""
             }
             ${bodyHtml}
             
             <div class="answer-section ${
               q.isSubmitted ? "show" : ""
             }" id="ansPanel">
                ${statusBadge}
                <div style="margin-bottom:10px;">
                   <span style="font-weight:bold; color:#1e293b">å‚è€ƒç­”æ¡ˆï¼š</span>
                   <span style="color:var(--primary); font-weight:bold; font-size:1.1rem">${
                     q.answer || "ç•¥"
                   }</span>
                </div>
                <div style="font-size:0.95rem; color:#475569; border-top:1px solid #e2e8f0; padding-top:10px; line-height:1.6">
                   <strong>è§£æï¼š</strong><br>${q.explanation || "æš‚æ— "}
                </div>
                
                ${showRemoveBtn ? `
                <button class="remove-wrong-btn" onclick="removeFromWrongBook('${q._uid}')">
                    ğŸ—‘ï¸ æˆ‘å­¦ä¼šäº†ï¼Œç§»å‡ºé”™é¢˜æœ¬
                </button>` : ''}

                ${showAiBtn ? `
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:15px;">
                  <button class="ai-btn" onclick="askAI()">ğŸ¤– AI æ·±åº¦è§£æ</button>
                  <button class="ai-btn" style="background:#64748b" onclick="copyPrompt()">ğŸ“‹ å¤åˆ¶é¢˜ç›®(æ‰‹åŠ¨é—®AI)</button>
                </div>
                <div id="aiResult" class="ai-result"></div>` : ''}
             </div>
          </div>
        `;
      }

      // === é”™é¢˜æœ¬é€»è¾‘ ===
      function addToWrongBook(q) {
          if (!q._uid) return;
          if (!wrongSet.has(q._uid)) {
              wrongSet.add(q._uid);
              localStorage.setItem("wrong_questions", JSON.stringify(Array.from(wrongSet)));
          }
      }

      window.removeFromWrongBook = function(uid) {
          if(confirm("ç¡®å®šå·²æŒæ¡è¿™é“é¢˜å¹¶å°†å…¶ç§»å‡ºé”™é¢˜æœ¬å—ï¼Ÿ")) {
              wrongSet.delete(uid);
              localStorage.setItem("wrong_questions", JSON.stringify(Array.from(wrongSet)));
              loadWrongBook(); // åˆ·æ–°ç•Œé¢
          }
      };

      // === AI è®¾ç½®é€»è¾‘ ===
      function openAiSettings() {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("aiModal").style.display = "block";
        
        // åŠ è½½ä¿å­˜çš„è®¾ç½®
        const provider = localStorage.getItem("ai_provider") || "gemini";
        document.getElementById("aiProvider").value = provider;
        document.getElementById("geminiKey").value = localStorage.getItem("ai_gemini_key") || "";
        document.getElementById("geminiModel").value = localStorage.getItem("ai_gemini_model") || "gemini-1.5-flash-latest";
        
        // Qwen
        document.getElementById("qwenKey").value = localStorage.getItem("ai_qwen_key") || "";
        document.getElementById("qwenModel").value = localStorage.getItem("ai_qwen_model") || "qwen-turbo";

        // SiliconFlow
        document.getElementById("sfKey").value = localStorage.getItem("ai_sf_key") || "";
        document.getElementById("sfModel").value = localStorage.getItem("ai_sf_model") || "Qwen/Qwen2.5-72B-Instruct";

        // Custom
        document.getElementById("customUrl").value = localStorage.getItem("ai_custom_url") || "";
        document.getElementById("customKey").value = localStorage.getItem("ai_custom_key") || "";
        document.getElementById("customModel").value = localStorage.getItem("ai_custom_model") || "";
        
        toggleAiInputs();
      }

      function toggleAiInputs() {
        const type = document.getElementById("aiProvider").value;
        document.getElementById('geminiConfig').style.display = 'none';
        document.getElementById('qwenConfig').style.display = 'none';
        document.getElementById('siliconFlowConfig').style.display = 'none';
        document.getElementById('customConfig').style.display = 'none';

        if(type === 'gemini') {
            document.getElementById('geminiConfig').style.display = 'block';
        } else if (type === 'qwen') {
            document.getElementById('qwenConfig').style.display = 'block';
        } else if (type === 'siliconflow') {
            document.getElementById('siliconFlowConfig').style.display = 'block';
        } else {
            document.getElementById('customConfig').style.display = 'block';
        }
      }

      function closeAll() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("aiModal").style.display = "none";
        document.getElementById("sidebar").classList.remove("open");
        document.getElementById("overlay").classList.remove("active");
      }

      function saveAiSettings() {
        const provider = document.getElementById("aiProvider").value;
        localStorage.setItem("ai_provider", provider);
        
        if(provider === 'gemini') {
            const key = document.getElementById("geminiKey").value.trim();
            const model = document.getElementById("geminiModel").value;
            // å…è®¸ç•™ç©ºï¼Œç•™ç©ºåˆ™ä»£ç ä¸­ä¼šä½¿ç”¨BUILTIN_API_KEY
            if(key) localStorage.setItem("ai_gemini_key", key);
            else localStorage.removeItem("ai_gemini_key");
            
            localStorage.setItem("ai_gemini_model", model);
        } else if (provider === 'qwen') {
            const key = document.getElementById("qwenKey").value.trim();
            const model = document.getElementById("qwenModel").value;
            if(key) localStorage.setItem("ai_qwen_key", key);
            else localStorage.removeItem("ai_qwen_key"); // å…è®¸ç•™ç©ºå°è¯•å†…ç½®
            
            localStorage.setItem("ai_qwen_model", model);
        } else if (provider === 'siliconflow') {
            const key = document.getElementById("sfKey").value.trim();
            const model = document.getElementById("sfModel").value;
            if(!key) { alert("ç¡…åŸºæµåŠ¨ Key ä¸èƒ½ä¸ºç©º"); return; }
            localStorage.setItem("ai_sf_key", key);
            localStorage.setItem("ai_sf_model", model);
        } else {
            const url = document.getElementById("customUrl").value.trim().replace(/\/$/, ""); 
            const key = document.getElementById("customKey").value.trim();
            const model = document.getElementById("customModel").value.trim();
            
            if(!url || !key || !model) { alert("è‡ªå®šä¹‰é…ç½®æ‰€æœ‰å­—æ®µéƒ½å¿…å¡«"); return; }
            localStorage.setItem("ai_custom_url", url);
            localStorage.setItem("ai_custom_key", key);
            localStorage.setItem("ai_custom_model", model);
        }
        
        alert("é…ç½®å·²ä¿å­˜ï¼");
        closeAll();
      }

      // === AI æé—®é€»è¾‘ ===
      async function askAI() {
        const resultDiv = document.getElementById("aiResult");
        resultDiv.style.display = "block";
        resultDiv.classList.add("loading");
        resultDiv.innerHTML = "";
        
        const q = filteredList[curIndex];
        const prompt = `ä½ æ˜¯ä¸“ä¸šçš„å†å²è€å¸ˆã€‚è¯·è¯¦ç»†è§£æè¿™é“é¢˜ï¼Œè§£é‡Šä¸ºä»€ä¹ˆé€‰è¿™ä¸ªç­”æ¡ˆï¼Œä»¥åŠå…¶ä»–é€‰é¡¹ä¸ºä»€ä¹ˆé”™ã€‚
        é¢˜ç›®ï¼š${q.content}
        é€‰é¡¹ï¼š${JSON.stringify(q.options || [])}
        æ­£ç¡®ç­”æ¡ˆï¼š${q.answer}`;

        const provider = localStorage.getItem("ai_provider") || "gemini";
        
        try {
            let text = "";
            
            if (provider === 'gemini') {
                const apiKey = localStorage.getItem("ai_gemini_key");
                const modelName = localStorage.getItem("ai_gemini_model") || "gemini-1.5-flash-latest";
                if (!apiKey) throw new Error("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® Gemini Key");
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || response.statusText);
                }
                const data = await response.json();
                text = data.candidates?.[0]?.content?.parts?.[0]?.text || "æ— å†…å®¹";
                
            } else if (provider === 'qwen') {
                // é€šä¹‰çµç 
                const apiKey = localStorage.getItem("ai_qwen_key");
                const modelName = localStorage.getItem("ai_qwen_model") || "qwen-turbo";
                // ä½¿ç”¨ä¿å­˜çš„ Keyï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å†…ç½® Key
                const finalKey = apiKey || BUILTIN_API_KEY;

                if (!finalKey) throw new Error("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® é€šä¹‰çµç  Key");

                const response = await fetch(`https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${finalKey}`
                    },
                    body: JSON.stringify({
                        model: modelName,
                        messages: [{ role: "user", content: prompt }]
                    })
                });

                if (!response.ok) {
                    if (response.status === 0) throw new Error("CORS è·¨åŸŸé”™è¯¯ï¼šé˜¿é‡Œäº‘æ¥å£é»˜è®¤æ‹¦æˆªç½‘é¡µè¯·æ±‚ã€‚<br>å»ºè®®ï¼š1.å®‰è£…è·¨åŸŸæ’ä»¶(Allow CORS) 2.åˆ‡æ¢åˆ°â€œç¡…åŸºæµåŠ¨â€é€‰é¡¹(æ¨è)");
                    const errText = await response.text();
                    throw new Error(`API é”™è¯¯ (${response.status}): ${errText}`);
                }

                const data = await response.json();
                text = data.choices?.[0]?.message?.content || "æ— å†…å®¹";

            } else if (provider === 'siliconflow') {
                // ç¡…åŸºæµåŠ¨
                const apiKey = localStorage.getItem("ai_sf_key");
                const modelName = localStorage.getItem("ai_sf_model") || "Qwen/Qwen2.5-72B-Instruct";
                if (!apiKey) throw new Error("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®ç¡…åŸºæµåŠ¨ Key");

                const response = await fetch(`https://api.siliconflow.cn/v1/chat/completions`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelName,
                        messages: [{ role: "user", content: prompt }]
                    })
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`API é”™è¯¯ (${response.status}): ${errText}`);
                }

                const data = await response.json();
                text = data.choices?.[0]?.message?.content || "æ— å†…å®¹";

            } else {
                // è‡ªå®šä¹‰
                const url = localStorage.getItem("ai_custom_url");
                const key = localStorage.getItem("ai_custom_key");
                const model = localStorage.getItem("ai_custom_model");
                
                if (!url || !key) throw new Error("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®è‡ªå®šä¹‰ API ä¿¡æ¯");

                const response = await fetch(`${url}/chat/completions`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: "user", content: prompt }]
                    })
                });
                
                if (!response.ok) {
                    if (response.status === 0) throw new Error("ç½‘ç»œé”™è¯¯(è·¨åŸŸCORSé™åˆ¶)ï¼Œè¯·å°è¯•ä½¿ç”¨ Gemini æˆ– ç¡…åŸºæµåŠ¨ã€‚");
                    const errText = await response.text();
                    throw new Error(`API é”™è¯¯ (${response.status}): ${errText}`);
                }
                
                const data = await response.json();
                text = data.choices?.[0]?.message?.content || "æ— å†…å®¹";
            }

            resultDiv.classList.remove("loading");
            resultDiv.innerHTML = text.replace(/\n/g, "<br>").replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");

        } catch (e) {
            resultDiv.classList.remove("loading");
            let errorMsg = `<span style="color:red">è¯·æ±‚å¤±è´¥ï¼š${e.message}</span>`;
            
            if (e.message.includes("quota") || e.message.includes("429")) {
                errorMsg += `<br><br>ğŸ’¡ <strong>é…é¢ä¸è¶³</strong>ï¼šè¯·æ£€æŸ¥æ‚¨çš„è´¦æˆ·ä½™é¢æˆ–å…è´¹é¢åº¦ã€‚`;
            } else if (e.message.includes("Failed to fetch")) {
                errorMsg += `<br><br>ğŸ’¡ <strong>ç½‘ç»œé”™è¯¯</strong>ï¼šå¦‚æœæ˜¯é€šä¹‰çµç (é˜¿é‡Œäº‘)ï¼Œé€šå¸¸æ˜¯æµè§ˆå™¨æ‹¦æˆªäº†è¯·æ±‚ã€‚æ¨èåˆ‡æ¢åˆ°ã€ç¡…åŸºæµåŠ¨ã€‘é€‰é¡¹ï¼Œå®ƒä¹Ÿæ˜¯é€šä¹‰æ¨¡å‹ï¼Œä½†å®Œç¾æ”¯æŒç½‘é¡µç›´è¿ã€‚`;
            }

            resultDiv.innerHTML = errorMsg;
        }
      }
      
      function copyPrompt() {
        const q = filteredList[curIndex];
        const prompt = `è¯·è§£æè¿™é“å†å²é¢˜ï¼š${q.content}ã€‚é€‰é¡¹ï¼š${JSON.stringify(q.options || []).replace(/"/g, '')}ã€‚æ­£ç¡®ç­”æ¡ˆï¼š${q.answer}`;
        
        const tempInput = document.createElement("textarea");
        tempInput.value = prompt;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);
        
        alert("âœ… é¢˜ç›®å·²å¤åˆ¶ï¼\nä½ å¯ä»¥å»ç²˜è´´æé—®äº†ã€‚");
      }

      // === äº¤äº’ ===
      window.handleOpt = function (label) {
        const q = filteredList[curIndex];
        if (q.isSubmitted) return;

        const isMulti =
          (q.type && q.type.includes("å¤š")) ||
          (q.answer && q.answer.length > 1);
        if (isMulti) {
          if (userSel.has(label)) userSel.delete(label);
          else userSel.add(label);
        } else {
          userSel.clear();
          userSel.add(label);
        }
        q.userSel = new Set(userSel);
        renderQ();
      };

      window.handleMainAction = function () {
        const q = filteredList[curIndex];
        if (q.isSubmitted) {
          move(1);
        } else {
          q.isSubmitted = true;
          
          // === æ ¸å¿ƒé€»è¾‘ï¼šåˆ¤æ–­å¯¹é”™å¹¶åŠ å…¥é”™é¢˜æœ¬ ===
          if (q.type && q.type.includes("é€‰")) { // åªé’ˆå¯¹é€‰æ‹©é¢˜
              const status = getQuestionStatus(q);
              // å¦‚æœåˆ¤åˆ†ä¸ºé”™è¯¯æˆ–åŠå¯¹ï¼Œéƒ½åŠ å…¥é”™é¢˜æœ¬
              if (status === 'wrong' || status === 'partial') {
                  addToWrongBook(q);
              }
          }

          // ä»…åœ¨éä¹±åºã€éé”™é¢˜æœ¬æ¨¡å¼ä¸‹ä¿å­˜è¿›åº¦
          if(curMod !== 'random_drill' && curMod !== 'wrong_book') {
              saveProgress();
              initSidebar();
          }
          
          renderQ();
          
          // æäº¤åç«‹åˆ»æ›´æ–°å½“å‰é¢˜ç›®çš„ä¸‹æ‹‰æ¡†æ ‡è®°
          const status = getQuestionStatus(q);
          let mark = "";
          if (status === 'correct') mark = " âœ…";
          else if (status === 'partial') mark = " ğŸŒ—";
          else if (status === 'wrong') mark = " âŒ";

          const sel = document.getElementById("qJumper");
          if (sel.options[curIndex]) sel.options[curIndex].text += mark;
        }
      };

      window.move = function (dir) {
        const next = curIndex + dir;
        if (next >= 0 && next < filteredList.length) {
          curIndex = next;
          renderQ();
        } else {
          if (dir === 1) alert("æœ¬åˆ—è¡¨é¢˜ç›®å·²ç»“æŸ");
        }
      };

      window.jumpTo = function (v) {
        curIndex = parseInt(v);
        renderQ();
      };

      window.toggleAns = function () {
        const p = document.getElementById("ansPanel");
        if (p) p.classList.toggle("show");
      };

      window.resetChapter = function () {
        if (!confirm(`æ¸…ç©ºå½“å‰è¿›åº¦ï¼Ÿ`)) return;
        rawList.forEach((q) => {
          q.isSubmitted = false;
          q.userSel = new Set();
        });
        if(curMod !== 'random_drill' && curMod !== 'wrong_book') {
            saveProgress();
            loadChapter(curChapter);
        } else {
            renderQ(); // ä¹±åºæ¨¡å¼åªé‡ç½®ç•Œé¢
        }
      };

      function saveProgress() {
        const state = rawList.map((q) => ({
          sel: Array.from(q.userSel),
          done: q.isSubmitted,
        }));
        localStorage.setItem(
          modules[curMod].prefix + curChapter,
          JSON.stringify(state)
        );
      }

      window.toggleSidebar = function () {
        document.getElementById("sidebar").classList.toggle("open");
        document.getElementById("overlay").classList.toggle("active");
      };
    </script>
  </body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>è¿‘ç°ä»£å² - è€ƒå‰å†²åˆºç»ˆæç‰ˆ V17.3</title>
    <style>
      :root {
        /* äº®è‰²æ¨¡å¼å˜é‡ */
        --primary: #4f46e5;
        --primary-light: #eef2ff;
        --primary-hover: #4338ca;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --text-main: #1f2937;
        --text-sub: #64748b;
        --bg-body: #f8fafc;
        --bg-card: #ffffff;
        --bg-sidebar: #ffffff;
        --border-color: #e2e8f0;
        --highlight-date: rgba(245, 158, 11, 0.15); /* æ—¥æœŸé«˜äº®åº•è‰² */
        --highlight-term: rgba(79, 70, 229, 0.1);   /* åè¯é«˜äº®åº•è‰² */
        
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --sidebar-width: 280px;
        --safe-bottom: env(safe-area-inset-bottom, 20px);
        
        /* å­—å·å˜é‡ */
        --font-size-base: 16px;
      }

      /* æ·±è‰²æ¨¡å¼å˜é‡ */
      body.dark-mode {
        --primary: #6366f1;
        --primary-light: #312e81;
        --primary-hover: #818cf8;
        --success: #34d399;
        --warning: #fbbf24;
        --error: #f87171;
        --text-main: #f1f5f9;
        --text-sub: #94a3b8;
        --bg-body: #0f172a;
        --bg-card: #1e293b;
        --bg-sidebar: #1e293b;
        --border-color: #334155;
        --highlight-date: rgba(251, 191, 36, 0.2);
        --highlight-term: rgba(99, 102, 241, 0.2);
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, "PingFang SC", sans-serif;
        background-color: var(--bg-body);
        color: var(--text-main);
        height: 100vh;
        display: flex;
        overflow: hidden;
        transition: background-color 0.3s, color 0.3s;
        font-size: var(--font-size-base);
      }

      /* === ä¾§è¾¹æ  === */
      .sidebar {
        width: var(--sidebar-width);
        background: var(--bg-sidebar);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        z-index: 50;
        transition: transform 0.3s, background-color 0.3s, border-color 0.3s;
        flex-shrink: 0;
      }

      .sidebar-header {
        padding: 20px;
        background: var(--bg-sidebar);
        border-bottom: 1px solid var(--border-color);
      }

      .app-brand {
        font-size: 1.2rem;
        font-weight: 800;
        color: var(--primary);
        text-align: center;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      
      /* å€’è®¡æ—¶æ ·å¼ */
      .countdown-box {
        background: linear-gradient(135deg, #4f46e5, #ec4899);
        color: white;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 15px;
        font-size: 0.9rem;
        box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        cursor: pointer;
      }
      .countdown-num {
        font-size: 1.4rem;
        font-weight: 800;
        margin: 0 4px;
        text-decoration: underline;
        text-underline-offset: 4px;
      }

      .mode-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 5px;
      }
      .mod-row {
        display: flex;
        background: var(--bg-body);
        padding: 3px;
        border-radius: 8px;
        gap: 4px;
      }
      .mod-tab {
        flex: 1;
        border: none;
        background: none;
        padding: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-sub);
        cursor: pointer;
        border-radius: 6px;
        transition: 0.2s;
        white-space: nowrap;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }
      .mod-tab.active {
        background: var(--bg-card);
        color: var(--primary);
        box-shadow: var(--shadow-sm);
      }
      /* ç‰¹æ®Šæ¨¡å¼æŒ‰é’® */
      .special-btn { color: var(--error); }
      .special-btn.active { background: var(--error); color: white; }
      
      .random-btn { color: var(--success); }
      .random-btn.active { background: var(--success); color: white; }
      
      .star-tab-btn { color: #f59e0b; }
      .star-tab-btn.active { background: #f59e0b; color: white; }

      .mock-btn { color: #8b5cf6; }
      .mock-btn.active { background: #8b5cf6; color: white; }

      .chapter-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .chapter-item {
        padding: 12px;
        margin-bottom: 6px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: center;
        color: var(--text-sub);
        transition: 0.2s;
        border: 1px solid transparent;
        font-size: 0.95em;
      }
      .chapter-item:hover {
        background: var(--primary-light);
      }
      .chapter-item.active {
        background: var(--primary-light);
        color: var(--primary);
        border-color: var(--primary);
        font-weight: 600;
      }

      .chap-row-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        margin-bottom: 4px;
      }

      .progress-track {
        height: 4px;
        width: 100%;
        background: var(--border-color);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 2px;
      }
      .progress-fill {
        height: 100%;
        background: var(--success);
        width: 0%;
        transition: width 0.5s ease;
      }

      .badge-pill {
        font-size: 0.7em;
        padding: 2px 8px;
        border-radius: 10px;
        background: var(--border-color);
        color: var(--text-sub);
      }
      .chapter-item.active .badge-pill {
        background: var(--bg-card);
        color: var(--primary);
      }

      /* === ä¸»å†…å®¹åŒº === */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
        background: var(--bg-body);
        position: relative;
        min-width: 0;
        transition: background-color 0.3s;
      }

      /* é¡¶éƒ¨å¯¼èˆª */
      .top-nav {
        background: var(--bg-card);
        padding: 10px 15px;
        box-shadow: var(--shadow-sm);
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 20;
        border-bottom: 1px solid var(--border-color);
        position: relative;
      }
      
      .exam-timer-bar {
        display: none;
        background: #1e293b;
        color: white;
        padding: 8px 15px;
        justify-content: space-between;
        align-items: center;
        font-variant-numeric: tabular-nums;
        font-weight: bold;
      }
      .exam-timer-bar.active { display: flex; }

      .nav-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .menu-toggle {
        font-size: 1.5rem;
        background: none;
        border: none;
        color: var(--text-sub);
        cursor: pointer;
        display: none;
        margin-right: 5px;
      }

      .nav-title {
        font-weight: 700;
        font-size: 1.1em;
        color: var(--text-main);
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }

      /* å…¨å±€æœç´¢æ¡† */
      .global-search-box {
        flex: 1;
        max-width: 300px;
        position: relative;
        display: flex;
        align-items: center;
      }
      .global-search-input {
        width: 100%;
        padding: 6px 10px;
        padding-left: 30px;
        border-radius: 20px;
        border: 1px solid var(--border-color);
        background: var(--bg-body);
        color: var(--text-main);
        font-size: 0.9em;
        transition: 0.2s;
      }
      .global-search-input:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px var(--primary-light);
      }
      .search-icon {
        position: absolute;
        left: 10px;
        color: var(--text-sub);
        font-size: 0.9em;
      }

      .jump-box {
        padding: 6px 8px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.85rem;
        color: var(--text-main);
        outline: none;
        background: var(--bg-body);
        max-width: 100px;
      }

      /* ç­›é€‰å™¨ */
      .filter-scroll {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 2px;
        scrollbar-width: none;
      }
      .filter-scroll::-webkit-scrollbar { display: none; }

      .filter-chip {
        padding: 5px 12px;
        border-radius: 20px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        color: var(--text-sub);
        font-size: 0.8rem;
        white-space: nowrap;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .filter-chip.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
      }

      /* å†…å®¹æ»šåŠ¨åŒº */
      .content-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        justify-content: center;
      }

      .card {
        background: var(--bg-card);
        border-radius: 16px;
        box-shadow: var(--shadow-md);
        padding: 25px;
        width: 100%;
        max-width: 800px;
        height: fit-content;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
        border: 1px solid var(--border-color);
        transition: background-color 0.3s, border-color 0.3s;
      }

      .card.knowledge-mode {
        border-left: 5px solid var(--warning);
      }
      .dark-mode .card.knowledge-mode {
        background: #2a2210;
      }
      
      .card.material-mode { border-left: 5px solid #8b5cf6; }
      .card.wrong-mode { border-left: 5px solid var(--error); }
      .card.fav-mode { border-left: 5px solid #f59e0b; }

      .q-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        align-items: center;
      }

      .q-type {
        font-size: 0.75rem;
        padding: 3px 8px;
        border-radius: 6px;
        font-weight: 700;
        background: var(--bg-body);
        color: var(--text-sub);
        border: 1px solid var(--border-color);
      }
      
      .star-icon {
        font-size: 1.5rem;
        cursor: pointer;
        color: #cbd5e1;
        transition: 0.2s;
        margin-left: 10px;
      }
      .star-icon.active {
        color: #f59e0b;
        transform: scale(1.2);
      }

      .q-content {
        font-size: 1.25em; /* ç¨å¾®åŠ å¤§é¢˜ç›®å­—å· */
        line-height: 1.7;
        color: var(--text-main);
        margin-bottom: 25px;
        white-space: pre-wrap;
      }
      
      /* é«˜äº®æ ·å¼ */
      .highlight-date {
        background-color: var(--highlight-date);
        color: var(--warning);
        font-weight: bold;
        padding: 0 4px;
        border-radius: 4px;
        transition: 0.2s;
      }
      .highlight-term {
        background-color: var(--highlight-term);
        color: var(--primary);
        font-weight: bold;
        padding: 0 4px;
        border-radius: 4px;
        border-bottom: 2px solid var(--primary);
        transition: 0.2s;
      }
      
      /* V17.3: æ™ºèƒ½é®æŒ¡/å¡«ç©ºæ¨¡å¼æ ·å¼ */
      .mask-active .highlight-date,
      .mask-active .highlight-term {
          background-color: #334155;
          color: transparent !important;
          border-color: transparent;
          cursor: pointer;
          border-radius: 6px;
          user-select: none;
      }
      .mask-active .highlight-date:hover,
      .mask-active .highlight-term:hover {
          background-color: #475569;
      }
      /* ç‚¹å‡»åæ˜¾ç¤ºçš„æ ·å¼ï¼ˆé€šè¿‡JSç§»é™¤classæˆ–æ·»åŠ shownç±»ï¼Œè¿™é‡Œç”¨ä¼ªç±»æ¨¡æ‹Ÿç‚¹å‡»åçŠ¶æ€ä¸å¤ªè¡Œï¼Œé JSç§»é™¤activeï¼‰ */
      /* ä½†æˆ‘ä»¬å¯ä»¥åšä¸€ä¸ª 'revealed' ç±» */
      .mask-active .highlight-date.revealed,
      .mask-active .highlight-term.revealed {
          background-color: var(--highlight-date);
          color: var(--warning) !important;
      }
      .mask-active .highlight-term.revealed {
          background-color: var(--highlight-term);
          color: var(--primary) !important;
          border-bottom: 2px solid var(--primary);
      }

      /* é€‰é¡¹ */
      .opts-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
        transition: 0.3s;
      }
      
      .opt-row {
        display: flex;
        padding: 15px;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        cursor: pointer;
        background: var(--bg-card);
        transition: 0.15s;
        align-items: flex-start;
        color: var(--text-main);
        font-size: 1em;
      }
      .opt-row:hover { border-color: #cbd5e1; }
      
      .opt-row.selected {
        border-color: var(--primary);
        background: var(--primary-light);
      }
      .opt-row.correct {
        border-color: var(--success);
        background: rgba(16, 185, 129, 0.1);
      }
      .opt-row.wrong {
        border-color: var(--error);
        background: rgba(239, 68, 68, 0.1);
      }
      .opt-row.missed {
        border-color: var(--warning);
        background: rgba(245, 158, 11, 0.1);
        border-style: dashed;
      }

      .opt-idx {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--bg-body);
        color: var(--text-sub);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9em;
        margin-right: 12px;
        flex-shrink: 0;
        border: 1px solid var(--border-color);
      }
      .opt-row.selected .opt-idx { background: var(--primary); color: white; border-color: var(--primary); }
      .opt-row.correct .opt-idx { background: var(--success); color: white; border-color: var(--success); }
      .opt-row.wrong .opt-idx { background: var(--error); color: white; border-color: var(--error); }
      .opt-row.missed .opt-idx { background: var(--warning); color: white; border-color: var(--warning); }

      /* ç­”æ¡ˆä¸è§£æ */
      .answer-section {
        margin-top: 25px;
        padding: 20px;
        background: var(--bg-body);
        border-radius: 12px;
        display: none;
        border: 1px solid var(--border-color);
      }
      .answer-section.show {
        display: block;
        animation: slideDown 0.3s;
      }
      
      .status-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: bold;
        margin-bottom: 15px;
      }
      .status-correct { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }
      .status-partial { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid var(--warning); }
      .status-wrong { background: rgba(239, 68, 68, 0.2); color: var(--error); border: 1px solid var(--error); }

      /* AI ç»“æœ */
      .ai-result {
        margin-top: 15px;
        padding: 15px;
        background: var(--bg-card);
        border: 1px solid var(--primary);
        border-radius: 8px;
        font-size: 0.95em;
        line-height: 1.6;
        color: var(--text-main);
        display: none;
      }

      /* åº•éƒ¨æ“ä½œæ  */
      .action-bar {
        background: var(--bg-card);
        border-top: 1px solid var(--border-color);
        padding: 12px 20px;
        padding-bottom: max(12px, var(--safe-bottom));
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }
      .btn:active { transform: scale(0.98); }
      .btn-secondary { background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border-color); }
      .btn-primary { background: var(--primary); color: white; flex: 2; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); }
      .btn-knowledge { background: var(--warning); color: white; flex: 2; }
      .btn-wrong { background: var(--error); color: white; flex: 2; }
      .btn-exam-submit { background: #8b5cf6; color: white; flex: 2; box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3); }

      .tool-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 20px;
      }
      .text-link {
        font-size: 0.85em;
        color: var(--text-sub);
        cursor: pointer;
        text-decoration: underline;
        background: none;
        border: none;
      }

      /* æ¨¡æ€æ¡† */
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 45;
        display: none;
        backdrop-filter: blur(2px);
      }
      .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--bg-card);
        padding: 25px;
        border-radius: 16px;
        width: 90%;
        max-width: 400px;
        z-index: 100;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        display: none;
        border: 1px solid var(--border-color);
        color: var(--text-main);
      }
      .modal h3 { margin-top: 0; color: var(--text-main); }
      .form-label { color: var(--text-sub); }
      .form-input {
        background: var(--bg-body);
        color: var(--text-main);
        border: 1px solid var(--border-color);
      }

      /* åº•éƒ¨å·¥å…·æŒ‰é’®ç»„ (Sidebar footer) */
      .sidebar-footer {
        padding: 15px;
        border-top: 1px solid var(--border-color);
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        background: var(--bg-sidebar);
      }
      .footer-btn {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--bg-body);
        color: var(--text-sub);
        font-size: 0.8rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        transition: 0.2s;
      }
      .footer-btn:hover { background: var(--bg-card); color: var(--primary); }

      /* åŠŸèƒ½åŒºæŒ‰é’®æ ·å¼è¡¥å…… */
      .continue-btn {
        background: var(--success); 
        color: white; 
        font-size: 0.8rem; 
        padding: 4px 8px; 
        border-radius: 4px; 
        border: none; 
        cursor: pointer;
        display: none;
        align-items: center;
        gap: 4px;
      }
      
      /* å­—å·æ§åˆ¶æ  */
      .font-ctrl {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px;
          background: var(--bg-body);
          border-radius: 8px;
          margin-bottom: 10px;
          grid-column: span 2;
      }
      .font-btn {
          width: 30px;
          height: 30px;
          border-radius: 4px;
          border: 1px solid var(--border-color);
          background: var(--bg-card);
          color: var(--text-main);
          font-weight: bold;
          cursor: pointer;
      }

      /* é—ªå¡å¼€å…³ */
      .switch-label {
          display: flex;
          align-items: center;
          gap: 6px;
          font-size: 0.85em;
          color: var(--text-sub);
          cursor: pointer;
          background: var(--bg-card);
          padding: 6px 12px;
          border-radius: 20px;
          border: 1px solid var(--border-color);
          font-weight: bold;
          color: var(--primary);
      }
      .switch-input {
          accent-color: var(--primary);
          width: 16px; height: 16px;
      }

      /* === V17.2 æ²‰æµ¸èƒŒè¯µæ¨¡å¼ (V17.2: å…¨è§ˆå¼) === */
      .recitation-layer {
          position: fixed;
          top: 0; left: 0; right: 0; bottom: 0;
          background: rgba(0, 0, 0, 0.85);
          backdrop-filter: blur(8px);
          z-index: 2000;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 20px;
      }
      
      .recitation-card {
          width: 100%;
          max-width: 650px;
          background: var(--bg-card);
          border-radius: 20px;
          padding: 30px;
          box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
          position: relative;
          cursor: default;
          border: 1px solid var(--border-color);
          display: flex;
          flex-direction: column;
          max-height: 85vh; /* é˜²æ­¢è¶…é•¿ */
          overflow-y: auto;
      }
      
      /* V17.3 é¡¶éƒ¨å·¥å…·æ  */
      .recitation-toolbar {
          display: flex;
          gap: 10px;
          margin-bottom: 15px;
          padding-bottom: 10px;
          border-bottom: 1px solid var(--border-color);
          overflow-x: auto;
      }
      .r-tool-btn {
          font-size: 0.85rem;
          padding: 6px 12px;
          border-radius: 20px;
          border: 1px solid var(--border-color);
          background: var(--bg-body);
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 5px;
          color: var(--text-sub);
          white-space: nowrap;
      }
      .r-tool-btn.active {
          background: var(--text-main);
          color: var(--bg-card);
          border-color: var(--text-main);
      }
      .r-tool-btn.play-active {
          background: var(--success);
          color: white;
          border-color: var(--success);
          animation: pulse-green 2s infinite;
      }
      @keyframes pulse-green {
          0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
          70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
          100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
      }
      
      .recitation-header {
          display: flex;
          justify-content: space-between;
          padding-bottom: 10px;
          margin-bottom: 15px;
          color: var(--text-sub);
          font-size: 0.9em;
      }
      
      .recitation-q {
          font-size: 1.35rem;
          font-weight: 800;
          margin-bottom: 25px;
          line-height: 1.6;
          color: var(--text-main);
      }
      
      /* V17.2 èƒŒè¯µæ¨¡å¼ä¸“ç”¨é€‰é¡¹åˆ—è¡¨ */
      .recitation-opts-list {
          display: flex;
          flex-direction: column;
          gap: 10px;
          margin-bottom: 25px;
      }
      .recitation-opt-item {
          padding: 12px 15px;
          border-radius: 8px;
          border: 1px solid var(--border-color);
          background: var(--bg-body);
          display: flex;
          gap: 10px;
          align-items: flex-start;
          color: var(--text-main);
          font-size: 1rem;
      }
      .recitation-opt-item.correct-answer {
          background: rgba(16, 185, 129, 0.15);
          border-color: var(--success);
          font-weight: bold;
          position: relative;
      }
      .recitation-opt-item.correct-answer::after {
          content: 'âœ…';
          position: absolute;
          right: 15px;
          top: 50%;
          transform: translateY(-50%);
      }
      .recitation-opt-badge {
          font-weight: bold;
          min-width: 25px;
      }
      
      .recitation-explanation {
          background: rgba(79, 70, 229, 0.05);
          padding: 15px;
          border-radius: 10px;
          border: 1px dashed var(--primary);
          font-size: 0.95em;
          line-height: 1.6;
          color: var(--text-main);
      }
      
      .recitation-nav {
          position: absolute;
          bottom: 40px;
          left: 0; right: 0;
          display: flex;
          justify-content: center;
          gap: 30px;
          pointer-events: none; 
      }
      .recitation-btn {
          pointer-events: auto;
          background: rgba(255,255,255,0.15);
          color: white;
          border: 1px solid rgba(255,255,255,0.4);
          padding: 15px 35px;
          border-radius: 50px;
          font-weight: bold;
          cursor: pointer;
          transition: 0.2s;
          backdrop-filter: blur(10px);
          font-size: 1rem;
          box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      }
      .recitation-btn:hover {
          background: white;
          color: black;
          transform: translateY(-2px);
      }
      .recitation-btn:active { transform: translateY(0); }
      
      .recitation-close {
          position: absolute;
          top: 20px; right: 20px;
          color: white;
          font-size: 2rem;
          cursor: pointer;
          opacity: 0.7;
          z-index: 2001;
      }
      .recitation-close:hover { opacity: 1; }

      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          left: -100%;
          height: 100%;
          width: 85%;
          box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
        }
        .sidebar.open { left: 0; }
        .menu-toggle { display: block; }
        .overlay.active { display: block; }
        .nav-row { flex-wrap: wrap; }
        .global-search-box { max-width: 100%; order: 3; margin-top: 5px; }
        
        .recitation-card { padding: 20px; margin: 0 15px; max-height: 80vh; }
        .recitation-q { font-size: 1.2rem; }
        .recitation-nav { bottom: 20px; }
        .recitation-btn { padding: 12px 25px; font-size: 0.9rem; }
      }

      @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
  </head>
  <body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="app-brand">âš¡ï¸ å†²åˆºå¤ä¹  Pro V17.3</div>
        
        <!-- å€’è®¡æ—¶æ¨¡å— -->
        <div class="countdown-box" onclick="editExamDate()" title="ç‚¹å‡»ä¿®æ”¹æ—¥æœŸ">
            <div>ğŸ”¥ è·ç¦»æœŸæœ«è€ƒè¯•è¿˜æœ‰</div>
            <div style="margin:8px 0">
                <span class="countdown-num" id="daysLeft">5</span> å¤©
            </div>
            <div style="font-size:0.75rem; opacity:0.9" id="examDateStr">åŠ æ²¹ï¼å…¨åœºé€šåƒï¼</div>
        </div>

        <!-- æ¨¡å¼é€‰æ‹©åŒº -->
        <div class="mode-group">
            <div class="mod-row">
                <button class="mod-tab active" onclick="switchModule('postgrad')" id="tab-pg">ğŸ“š è€ƒç ”çœŸé¢˜</button>
                <button class="mod-tab" onclick="switchModule('history')" id="tab-hist">ğŸ“ è¯¾åç»ƒä¹ </button>
            </div>
            <div class="mod-row">
                <!-- é”™é¢˜æœ¬ -->
                <button class="mod-tab special-btn" onclick="switchModule('wrong_book')" id="tab-wrong">
                   âŒ é”™é¢˜é›† <span id="wbCount" style="font-size:0.75rem; margin-left:2px; opacity:0.8">(0)</span>
                </button>
                <!-- æ”¶è—å¤¹ -->
                <button class="mod-tab star-tab-btn" onclick="switchModule('favorites')" id="tab-fav">
                   â­ æ”¶è—å¤¹ <span id="favCount" style="font-size:0.75rem; margin-left:2px; opacity:0.8">(0)</span>
                </button>
            </div>
            <div class="mod-row">
                <!-- ä¹±åº -->
                <button class="mod-tab random-btn" onclick="switchModule('random_drill')" id="tab-random">ğŸ”€ ä¹±åºåˆ·é¢˜</button>
                <!-- æ¨¡æ‹Ÿè€ƒè¯• -->
                <button class="mod-tab mock-btn" onclick="startMockExam()" id="tab-mock">ğŸ“ æ¨¡æ‹Ÿè€ƒè¯•</button>
            </div>
        </div>
      </div>

      <div class="chapter-list" id="chapterList"></div>
      
      <!-- åº•éƒ¨å·¥å…·åŒº -->
      <div class="sidebar-footer">
        <!-- å­—å·è°ƒèŠ‚ -->
        <div class="font-ctrl">
            <span style="font-size:0.8rem; color:var(--text-sub)">å­—ä½“å¤§å°</span>
            <div style="display:flex; gap:5px">
                <button class="font-btn" onclick="changeFontSize(-1)">A-</button>
                <button class="font-btn" onclick="changeFontSize(1)">A+</button>
            </div>
        </div>
        
        <button class="footer-btn" onclick="openAiSettings()">âš™ï¸ AI è®¾ç½®</button>
        <button class="footer-btn" onclick="toggleDarkMode()" id="darkModeBtn">ğŸŒ™ å¤œé—´æ¨¡å¼</button>
        <button class="footer-btn" onclick="exportData()">ğŸ’¾ å¤‡ä»½è¿›åº¦</button>
        <button class="footer-btn" onclick="importData()">ğŸ“‚ æ¢å¤è¿›åº¦</button>
        <button class="footer-btn" style="grid-column: span 2; color: var(--error); border-color: #fecdd3;" onclick="resetChapter()">ğŸ—‘ï¸ æ¸…ç©ºå½“å‰ç« èŠ‚</button>
      </div>
    </div>
    
    <div class="overlay" id="overlay" onclick="closeAll()"></div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
    <input type="file" id="fileInput" style="display:none" accept=".json" onchange="handleFileImport(this)">

    <!-- AI è®¾ç½®å¼¹çª— -->
    <div class="modal" id="aiModal">
      <h3>é…ç½® AI æœåŠ¡</h3>
      <div class="form-group" style="margin-bottom:15px">
        <label class="form-label">é€‰æ‹©æœåŠ¡å•†</label>
        <select class="form-input" id="aiProvider" onchange="toggleAiInputs()" style="width:100%; padding:10px; border-radius:8px; margin-top:5px;">
          <option value="gemini">Google Gemini</option>
          <option value="qwen">é€šä¹‰çµç  (é˜¿é‡Œäº‘ DashScope)</option>
          <option value="siliconflow">é€šä¹‰åƒé—® (ç¡…åŸºæµåŠ¨ - æ¨è)</option>
          <option value="custom">Custom (OpenAI Compatible)</option>
        </select>
      </div>
      
      <!-- AIé…ç½®ç»†èŠ‚çœç•¥ï¼Œå¤ç”¨åŸæœ‰é€»è¾‘ -->
      <div id="geminiConfig"><label class="form-label">API Key</label><input type="password" id="geminiKey" class="form-input" style="width:100%; padding:10px; margin-top:5px;" placeholder="å†…ç½®Keyæˆ–è¾“å…¥" /></div>
      <div id="qwenConfig" style="display:none"><label class="form-label">API Key</label><input type="password" id="qwenKey" class="form-input" style="width:100%; padding:10px; margin-top:5px;" /></div>
      <div id="siliconFlowConfig" style="display:none"><label class="form-label">API Key</label><input type="password" id="sfKey" class="form-input" style="width:100%; padding:10px; margin-top:5px;" /></div>
      <div id="customConfig" style="display:none"><input type="text" id="customUrl" class="form-input" placeholder="URL" style="width:100%; padding:10px; margin-top:5px;" /><input type="password" id="customKey" class="form-input" placeholder="Key" style="width:100%; padding:10px; margin-top:5px;" /></div>

      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
        <button class="btn btn-secondary" onclick="closeAll()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveAiSettings()">ä¿å­˜é…ç½®</button>
      </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div class="main-content">
      <!-- æ¨¡æ‹Ÿè€ƒè¯•è®¡æ—¶æ¡ -->
      <div class="exam-timer-bar" id="examTimerBar">
          <div>â³ å‰©ä½™æ—¶é—´ï¼š<span id="examCountdown" style="color:#fbbf24; font-size:1.2rem">45:00</span></div>
          <button style="background:#ef4444; border:none; color:white; padding:4px 12px; border-radius:4px; cursor:pointer" onclick="submitMockExam()">ğŸ“¥ æå‰äº¤å·</button>
      </div>

      <div class="top-nav" id="normalTopNav">
        <div class="nav-row">
            <div style="display: flex; align-items: center; gap:8px;">
                <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
                <div style="display:flex; flex-direction:column;">
                    <div class="nav-title" id="headerTitle">è¯·é€‰æ‹©ç« èŠ‚</div>
                    <button id="continueBtn" class="continue-btn" onclick="jumpToUnfinished()">â­ï¸ ç»§ç»­ (<span id="unfinishedCount">0</span>)</button>
                </div>
            </div>
            
            <!-- å…¨å±€æœç´¢ -->
            <div class="global-search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" class="global-search-input" id="searchBox" placeholder="æœå†å²äº‹ä»¶/å¹´ä»½..." oninput="handleSearch(this.value)">
            </div>

            <select class="jump-box" id="qJumper" onchange="jumpTo(this.value)" disabled>
                <option>0/0</option>
            </select>
        </div>

        <div class="filter-scroll" id="filterBar">
          <button class="filter-chip active" onclick="setFilter('all')">â™¾ï¸ å…¨éƒ¨</button>
          <button class="filter-chip" onclick="setFilter('çŸ¥è¯†ç‚¹')">ğŸ’¡ çŸ¥è¯†ç‚¹</button>
          <button class="filter-chip" onclick="setFilter('å•é€‰')">ğŸ”´ å•é€‰é¢˜</button>
          <button class="filter-chip" onclick="setFilter('å¤šé€‰')">ğŸ”µ å¤šé€‰é¢˜</button>
          <button class="filter-chip" onclick="setFilter('ç®€ç­”')">ğŸŸ¢ ç®€ç­”é¢˜</button>
          <button class="filter-chip" onclick="setFilter('ææ–™')">ğŸ“œ ææ–™é¢˜</button>
        </div>
      </div>

      <div class="content-area" id="qContainer">
        <div style="text-align: center; margin-top: 100px; color: var(--text-sub)">
          <div style="font-size: 3rem; margin-bottom: 10px">ğŸ‘ˆ</div>
          è¯·åœ¨å·¦ä¾§ç›®å½•é€‰æ‹©æ¨¡å¼å¼€å§‹å¤ä¹ 
        </div>
      </div>

      <div class="tool-row" id="toolRow">
        <div style="display:flex; gap:15px; align-items:center;">
            <button class="text-link" onclick="toggleAns()">ğŸ‘ï¸ æ˜¾ç¤ºç­”æ¡ˆ</button>
            <label class="switch-label" title="å¼€å¯æ‚¬æµ®æ²‰æµ¸èƒŒè¯µæ¨¡å¼ï¼Œåªçœ‹é¢˜å’Œç­”æ¡ˆ">
                <input type="checkbox" class="switch-input" id="flashcardToggle" onchange="toggleFlashcardMode()"> 
                ğŸ§  æé€ŸèƒŒé¢˜æ¨¡å¼
            </label>
        </div>
        <span id="scoreText" style="font-size: 0.85rem; color: var(--text-sub)"></span>
      </div>

      <div class="action-bar">
        <button class="btn btn-secondary" onclick="move(-1)">â¬…ï¸ ä¸Šä¸€é¢˜</button>
        <button class="btn btn-primary" id="mainBtn" onclick="handleMainAction()">âœ… æäº¤ç­”æ¡ˆ</button>
        <button class="btn btn-secondary" onclick="move(1)">ä¸‹ä¸€é¢˜ â¡ï¸</button>
      </div>
    </div>

    <!-- V17.2: æ²‰æµ¸èƒŒè¯µæ¨¡å¼ (æé€Ÿç‰ˆ) -->
    <div id="recitationLayer" class="recitation-layer" style="display:none;">
        <div class="recitation-close" onclick="closeRecitationMode()">Ã—</div>
        <div class="recitation-card">
            <!-- V17.3: é¡¶éƒ¨å·¥å…·æ  (æ™ºèƒ½å¡«ç©º & è‡ªåŠ¨æ’­æ”¾) -->
            <div class="recitation-toolbar">
                <button class="r-tool-btn" id="btnTape" onclick="toggleTapeMode()">
                    ğŸ–ï¸ æ™ºèƒ½å¡«ç©º
                </button>
                <button class="r-tool-btn" id="btnAutoPlay" onclick="toggleAutoPlay()">
                    â–¶ï¸ è‡ªåŠ¨æ’­æ”¾(4s)
                </button>
            </div>

            <div class="recitation-header">
                <span id="recitationIndex">1/100</span>
                <span id="recitationType">å•é€‰é¢˜</span>
                <span id="recitationStar" style="font-size:1.2rem; cursor:pointer" onclick="toggleFavCurrent()">â˜†</span>
            </div>
            
            <div class="recitation-q" id="recitationQText">é¢˜ç›®å†…å®¹...</div>
            
            <!-- V17.2: ç›´æ¥æ˜¾ç¤ºé€‰é¡¹åˆ—è¡¨ï¼ˆå¸¦é«˜äº®ï¼‰ -->
            <div id="recitationOpts" class="recitation-opts-list"></div>
            
            <!-- V17.2: ç›´æ¥æ˜¾ç¤ºè§£æ -->
            <div id="recitationExp" class="recitation-explanation"></div>
        </div>
        
        <div class="recitation-nav">
            <button class="recitation-btn" onclick="moveRecitation(-1)">â¬…ï¸ ä¸Šä¸€é¢˜</button>
            <button class="recitation-btn" onclick="moveRecitation(1)">ä¸‹ä¸€é¢˜ â¡ï¸</button>
        </div>
    </div>

    <script>
      // === æ ¸å¿ƒæ•°æ®ä¸é…ç½® ===
      const modules = {
        postgrad: { name: "è€ƒç ”çœŸé¢˜", data: [], prefix: "pg_" },
        history: { name: "è¯¾åç»ƒä¹ ", data: [], prefix: "hist_" },
        wrong_book: { name: "é”™é¢˜é›†", data: [], prefix: "wb_" },
        random_drill: { name: "ä¹±åºåˆ·é¢˜", data: [], prefix: "rd_" },
        favorites: { name: "æ”¶è—å¤¹", data: [], prefix: "fav_" },
        mock_exam: { name: "æ¨¡æ‹Ÿè€ƒè¯•", data: [], prefix: "mock_" }
      };

      const BUILTIN_API_KEY = "sk-60ffb14cd765472bb2de892c632ad0dc"; 
      
      let curMod = localStorage.getItem("last_mod") || "postgrad";
      let allData = [];
      let curChapter = "";
      let rawList = []; 
      let filteredList = [];
      let curIndex = 0; 
      let filterType = "all";
      let userSel = new Set(); 
      let wrongSet = new Set();
      let favoriteSet = new Set();
      
      // æ–°åŠŸèƒ½çŠ¶æ€
      let isRecitationMode = false;
      let fontSizeLevel = 0; // 0=base, 1=lg, 2=xl
      let isTapeMode = false; // æ™ºèƒ½å¡«ç©ºæ¨¡å¼
      let isAutoPlay = false; // è‡ªåŠ¨æ’­æ”¾æ¨¡å¼
      let autoPlayTimer = null;
      
      let isExamMode = false;
      let examTimer = null;
      let examSeconds = 45 * 60;

      // === åˆå§‹åŒ– ===
      window.onload = async () => {
        try {
          initDarkMode();
          initCountdown();
          initFontSize();

          const [res1, res2] = await Promise.allSettled([
            fetch("./questions.json").then((r) => r.json()),
            fetch("./history_questions.json").then((r) => r.json()),
          ]);

          modules.postgrad.data = frontendRepair(res1.status === "fulfilled" ? res1.value : []);
          modules.history.data = frontendRepair(res2.status === "fulfilled" ? res2.value : []);

          assignIds(modules.postgrad.data, "pg");
          assignIds(modules.history.data, "hist");

          loadAndCleanSets();
          syncWrongBookFromProgress(); // è‡ªåŠ¨ä¿®å¤é”™é¢˜æœ¬
          
          switchModule(curMod);
        } catch (e) {
          console.error(e);
          alert("è¯·ç¡®ä¿ç›®å½•ä¸‹å­˜åœ¨ questions.json å’Œ history_questions.json æ–‡ä»¶");
        }
      };
      
      // === V17.0 æ–°å¢ï¼šå­—å·è°ƒèŠ‚ ===
      function initFontSize() {
          const fs = localStorage.getItem("font_level");
          if(fs) {
              fontSizeLevel = parseInt(fs);
              applyFontSize();
          }
      }
      
      window.changeFontSize = function(dir) {
          fontSizeLevel += dir;
          if(fontSizeLevel < -1) fontSizeLevel = -1;
          if(fontSizeLevel > 3) fontSizeLevel = 3;
          localStorage.setItem("font_level", fontSizeLevel);
          applyFontSize();
      }
      
      function applyFontSize() {
          const base = 16;
          const newSize = base + (fontSizeLevel * 2);
          document.documentElement.style.setProperty('--font-size-base', `${newSize}px`);
      }
      
      // === V17.3 æ™ºèƒ½å¡«ç©º & è‡ªåŠ¨æ’­æ”¾ ===
      window.toggleTapeMode = function() {
          isTapeMode = !isTapeMode;
          const btn = document.getElementById("btnTape");
          const card = document.querySelector('.recitation-card');
          
          if(isTapeMode) {
              btn.classList.add('active');
              btn.innerHTML = "ğŸ–ï¸ å¡«ç©ºå·²å¼€å¯";
              card.classList.add('mask-active');
          } else {
              btn.classList.remove('active');
              btn.innerHTML = "ğŸ–ï¸ æ™ºèƒ½å¡«ç©º";
              card.classList.remove('mask-active');
          }
      }
      
      window.toggleAutoPlay = function() {
          isAutoPlay = !isAutoPlay;
          const btn = document.getElementById("btnAutoPlay");
          
          if(isAutoPlay) {
              btn.classList.add('play-active');
              btn.innerHTML = "â¸ï¸ åœæ­¢æ’­æ”¾";
              startAutoPlayLoop();
          } else {
              btn.classList.remove('play-active');
              btn.innerHTML = "â–¶ï¸ è‡ªåŠ¨æ’­æ”¾(4s)";
              stopAutoPlayLoop();
          }
      }
      
      function startAutoPlayLoop() {
          stopAutoPlayLoop();
          autoPlayTimer = setInterval(() => {
              if(!isRecitationMode) { stopAutoPlayLoop(); return; }
              moveRecitation(1);
          }, 4000); // 4ç§’ä¸€é¢˜
      }
      
      function stopAutoPlayLoop() {
          if(autoPlayTimer) clearInterval(autoPlayTimer);
          autoPlayTimer = null;
      }
      
      // === V17.1 æ–°å¢ï¼šæ²‰æµ¸èƒŒè¯µæ¨¡å¼ ===
      window.toggleFlashcardMode = function() {
          const toggle = document.getElementById("flashcardToggle");
          isRecitationMode = toggle.checked;
          const layer = document.getElementById("recitationLayer");
          
          if(isRecitationMode) {
              if(filteredList.length === 0) {
                  alert("å½“å‰åˆ—è¡¨æ²¡æœ‰é¢˜ç›®ï¼Œæ— æ³•è¿›å…¥èƒŒè¯µæ¨¡å¼");
                  toggle.checked = false;
                  return;
              }
              layer.style.display = "flex";
              renderRecitationCard();
              
              // ç»‘å®šé”®ç›˜äº‹ä»¶
              window.addEventListener('keydown', handleRecitationKey);
          } else {
              layer.style.display = "none";
              window.removeEventListener('keydown', handleRecitationKey);
              stopAutoPlayLoop(); // é€€å‡ºæ—¶åœæ­¢è‡ªåŠ¨æ’­æ”¾
              // é‡ç½®æŒ‰é’®UI
              isAutoPlay = false;
              document.getElementById("btnAutoPlay").classList.remove('play-active');
              document.getElementById("btnAutoPlay").innerHTML = "â–¶ï¸ è‡ªåŠ¨æ’­æ”¾(4s)";
              renderQ(); // æ¢å¤æ™®é€šè§†å›¾
          }
      }
      
      function handleRecitationKey(e) {
          if(!isRecitationMode) return;
          if(e.key === 'ArrowRight' || e.key === ' ') moveRecitation(1);
          if(e.key === 'ArrowLeft') moveRecitation(-1);
      }
      
      window.closeRecitationMode = function() {
          document.getElementById("flashcardToggle").checked = false;
          toggleFlashcardMode();
      }
      
      // V17.2: å…¨è§ˆå¼æ¸²æŸ“
      window.renderRecitationCard = function() {
          if(!isRecitationMode) return;
          const q = filteredList[curIndex];
          
          // å¡«å……å¤´éƒ¨ä¿¡æ¯
          document.getElementById("recitationIndex").innerText = `${curIndex + 1} / ${filteredList.length}`;
          document.getElementById("recitationType").innerText = q.type || "é¢˜ç›®";
          
          // æ˜Ÿæ˜Ÿ
          const isFav = favoriteSet.has(q._uid);
          const starEl = document.getElementById("recitationStar");
          starEl.innerText = isFav ? 'â­' : 'â˜†';
          starEl.style.color = isFav ? '#f59e0b' : '#cbd5e1';
          
          // é¢˜ç›®
          const qText = document.getElementById("recitationQText");
          qText.innerHTML = highlightContent(q.content);
          bindMaskEvents(qText);
          
          // é€‰é¡¹æ¸²æŸ“ (ç›´æ¥æ¸²æŸ“å¹¶é«˜äº®)
          const optsDiv = document.getElementById("recitationOpts");
          optsDiv.innerHTML = "";
          
          if (q.type && q.type.includes("é€‰") && q.options && q.options.length > 0) {
              const correctLabels = (q.answer || "").toUpperCase().split("");
              
              q.options.forEach(opt => {
                  const isCorrect = correctLabels.includes(opt.label);
                  const div = document.createElement("div");
                  div.className = `recitation-opt-item ${isCorrect ? 'correct-answer' : ''}`;
                  // é€‰é¡¹å†…å®¹ä¹Ÿæ”¯æŒé«˜äº®å’Œé®æŒ¡
                  div.innerHTML = `
                      <span class="recitation-opt-badge">${opt.label}.</span>
                      <span>${highlightContent(opt.text)}</span>
                  `;
                  bindMaskEvents(div);
                  optsDiv.appendChild(div);
              });
          } else if(q.type === "çŸ¥è¯†ç‚¹") {
              optsDiv.innerHTML = `<div style="color:var(--text-sub); font-style:italic">ï¼ˆèƒŒè¯µçŸ¥è¯†ç‚¹ï¼‰</div>`;
          } else {
              optsDiv.innerHTML = `<div style="padding:15px; background:var(--bg-body); font-weight:bold; color:var(--success)">âœ… å‚è€ƒç­”æ¡ˆï¼š${q.answer}</div>`;
          }
          
          // è§£æ
          const expDiv = document.getElementById("recitationExp");
          expDiv.innerHTML = `<strong>ğŸ’¡ æ ¸å¿ƒè§£æï¼š</strong><br>${highlightContent(q.explanation || "æš‚æ— è§£æ")}`;
          bindMaskEvents(expDiv);
      }
      
      // è¾…åŠ©ï¼šç»™é«˜äº®å…ƒç´ ç»‘å®šç‚¹å‡»æ­æ™“äº‹ä»¶
      function bindMaskEvents(container) {
          const spans = container.querySelectorAll('.highlight-date, .highlight-term');
          spans.forEach(span => {
              span.onclick = function(e) {
                  if(isTapeMode) {
                      e.stopPropagation();
                      this.classList.toggle('revealed');
                  }
              }
          });
      }
      
      window.moveRecitation = function(dir) {
          const n = curIndex + dir;
          if (n >= 0 && n < filteredList.length) { 
              curIndex = n; 
              renderRecitationCard(); 
          } else {
              if(isAutoPlay) {
                  stopAutoPlayLoop(); // åˆ°åº•äº†åœæ­¢æ’­æ”¾
                  alert("è‡ªåŠ¨æ’­æ”¾å·²ç»“æŸï¼šæœ¬ç« é¢˜ç›®å·²æ’­å®Œ");
                  isAutoPlay = false;
                  document.getElementById("btnAutoPlay").classList.remove('play-active');
                  document.getElementById("btnAutoPlay").innerHTML = "â–¶ï¸ è‡ªåŠ¨æ’­æ”¾(4s)";
              } else {
                  if (dir === 1) alert("æœ¬ç»„é¢˜ç›®å·²èƒŒå®Œï¼");
              }
          }
      }
      
      window.toggleFavCurrent = function() {
          const q = filteredList[curIndex];
          toggleFav(q._uid);
          // æ‰‹åŠ¨æ›´æ–°æ˜Ÿæ˜Ÿï¼Œå› ä¸ºtoggleFavä¼šåˆ·æ–°renderQï¼Œä½†ä¸ä¸€å®šåˆ·æ–°Recitation
          const isFav = favoriteSet.has(q._uid);
          const starEl = document.getElementById("recitationStar");
          starEl.innerText = isFav ? 'â­' : 'â˜†';
          starEl.style.color = isFav ? '#f59e0b' : '#cbd5e1';
      }
      
      // === V17.0 æ–°å¢ï¼šæ™ºèƒ½é«˜äº® helper ===
      function highlightContent(text) {
          if (!text) return "";
          // 1. é«˜äº®å¹´ä»½ (ä¾‹å¦‚ 1840å¹´, 1919, 1945.8)
          let res = text.replace(/(\d{4}(?:å¹´|[\.\-]\d{1,2})?)/g, '<span class="highlight-date">$1</span>');
          
          // 2. é«˜äº®å¸¸è§å†å²å…³é”®è¯ (å¯æ‰©å±•)
          const keywords = ["è¾›äº¥é©å‘½", "äº”å››è¿åŠ¨", "å…±äº§å…š", "å›½æ°‘å…š", "æ¯›æ³½ä¸œ", "å­™ä¸­å±±", "æŠ—æ—¥æˆ˜äº‰", "è§£æ”¾æˆ˜äº‰", "é¸¦ç‰‡æˆ˜äº‰", "é©¬å…³æ¡çº¦", "å—äº¬æ¡çº¦"];
          keywords.forEach(kw => {
              const reg = new RegExp(kw, 'g');
              res = res.replace(reg, '<span class="highlight-term">$&</span>');
          });
          return res;
      }
      
      // === V17.0 æ–°å¢ï¼šå…¨å±€æœç´¢ ===
      window.handleSearch = function(val) {
          if(!val.trim()) {
              if (curMod === 'search_result') switchModule('postgrad'); // é€€å‡ºæœç´¢å›ä¸»é¡µ
              return;
          }
          
          // èŠ‚æµç®€å•å¤„ç†
          if(window.searchTimeout) clearTimeout(window.searchTimeout);
          window.searchTimeout = setTimeout(() => {
             performSearch(val.trim());
          }, 400);
      }
      
      function performSearch(keyword) {
          const pool = [...modules.postgrad.data, ...modules.history.data];
          const res = pool.filter(q => 
             q.content.includes(keyword) || 
             (q.options && q.options.some(o => o.text.includes(keyword)))
          );
          
          rawList = res;
          filteredList = res;
          curChapter = `ğŸ” æœç´¢: "${keyword}"`;
          curIndex = 0;
          
          // å¼ºåˆ¶åˆ‡æ¢åˆ°æœç´¢è§†å›¾
          // ä¸ºäº†ä¸ç ´å module é€»è¾‘ï¼Œæˆ‘ä»¬ä¸´æ—¶æ¸²æŸ“
          document.querySelectorAll('.mod-tab').forEach(btn => btn.classList.remove('active'));
          document.getElementById("chapterList").innerHTML = 
              `<div style="padding:15px; text-align:center; color:var(--text-sub)">
                 æ‰¾åˆ° <strong>${res.length}</strong> æ¡ç»“æœ
               </div>`;
          
          if(res.length === 0) {
              document.getElementById("qContainer").innerHTML = 
                `<div style="text-align:center; margin-top:50px;">ğŸ¤·â€â™‚ï¸ æœªæ‰¾åˆ°ç›¸å…³é¢˜ç›®</div>`;
              document.getElementById("headerTitle").innerText = curChapter;
              return;
          }
          
          renderQ();
      }

      // === V17.0 æ–°å¢ï¼šæ¸…ç©ºé”™é¢˜æœ¬ ===
      window.clearWrongBook = function() {
          if(wrongSet.size === 0) {
              alert("é”™é¢˜æœ¬å·²ç»æ˜¯ç©ºçš„äº†ï¼");
              return;
          }
          
          if(confirm("âš ï¸ é«˜èƒ½é¢„è­¦\n\næ‚¨ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é”™é¢˜è®°å½•å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) {
              wrongSet.clear();
              localStorage.setItem("wrong_questions", "[]");
              updateCounts();
              loadWrongBook(); // åˆ·æ–°ç•Œé¢
          }
      }

      // === åŸæœ‰é€»è¾‘ä¿æŒ ===
      function syncWrongBookFromProgress() {
        let hasUpdates = false;
        const processModule = (modKey) => {
            const mod = modules[modKey];
            if (!mod || !mod.data) return;
            const chapMap = {};
            mod.data.forEach(q => {
                if (!chapMap[q.chapter]) chapMap[q.chapter] = [];
                chapMap[q.chapter].push(q);
            });
            for (const [chapName, qList] of Object.entries(chapMap)) {
                const key = mod.prefix + chapName;
                const savedJson = localStorage.getItem(key);
                if (!savedJson) continue;
                try {
                    const saved = JSON.parse(savedJson);
                    qList.forEach((q, i) => {
                        if (saved[i] && saved[i].done && q.type && q.type.includes("é€‰")) {
                             const tempQ = { ...q, isSubmitted: true, userSel: new Set(saved[i].sel || []) };
                             const status = getQuestionStatus(tempQ);
                             if ((status === 'wrong' || status === 'partial') && !wrongSet.has(q._uid)) {
                                 wrongSet.add(q._uid);
                                 hasUpdates = true;
                             }
                        }
                    });
                } catch (e) {}
            }
        };
        processModule('postgrad');
        processModule('history');
        if (hasUpdates) {
            localStorage.setItem("wrong_questions", JSON.stringify(Array.from(wrongSet)));
            updateCounts();
        }
      }
      
      function initCountdown() {
          const storedDate = localStorage.getItem("exam_date");
          let targetDate = storedDate ? new Date(storedDate) : new Date(new Date().setDate(new Date().getDate() + 5));
          updateCountdownDisplay(targetDate);
      }
      
      function updateCountdownDisplay(targetDate) {
          targetDate.setHours(0,0,0,0);
          const today = new Date(); today.setHours(0,0,0,0);
          const diff = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
          document.getElementById("daysLeft").innerText = diff > 0 ? diff : 0;
          document.getElementById("examDateStr").innerText = `è€ƒè¯•æ—¥æœŸ: ${targetDate.toISOString().slice(0,10)}`;
          localStorage.setItem("exam_date", targetDate.toISOString());
      }
      
      window.editExamDate = function() {
          const input = prompt("è®¾ç½®è€ƒè¯•æ—¥æœŸ (YYYY-MM-DD)", new Date().toISOString().slice(0, 10));
          if (input && /^\d{4}-\d{2}-\d{2}$/.test(input)) updateCountdownDisplay(new Date(input));
      }

      function loadAndCleanSets() {
          const wSaved = localStorage.getItem("wrong_questions");
          const fSaved = localStorage.getItem("favorite_questions");
          const allIds = new Set();
          [...modules.postgrad.data, ...modules.history.data].forEach(q => allIds.add(q._uid));
          
          wrongSet = new Set();
          if (wSaved) JSON.parse(wSaved).forEach(id => { if (allIds.has(id)) wrongSet.add(id); });
          
          favoriteSet = new Set();
          if (fSaved) JSON.parse(fSaved).forEach(id => { if (allIds.has(id)) favoriteSet.add(id); });
          
          updateCounts();
      }

      function updateCounts() {
          document.getElementById("wbCount").innerText = `(${wrongSet.size})`;
          document.getElementById("favCount").innerText = `(${favoriteSet.size})`;
      }

      function assignIds(data, prefix) {
        if (!data) return;
        data.forEach((q, idx) => {
            let hash = 0; const str = q.chapter + q.content.substring(0,10);
            for(let i=0; i<str.length; i++) hash = (hash<<5) - hash + str.charCodeAt(i);
            q._uid = `${prefix}_${Math.abs(hash)}_${idx}`;
        });
      }

      function frontendRepair(data) {
        if (!data) return [];
        return data.map((q) => {
          if (q.type && q.type.includes("é€‰") && (!q.options || q.options.length === 0)) {
            const parts = q.content.split(/\s(?=[A-E][\.ï¼ã€])/);
            if (parts.length > 1) {
              q.content = parts[0]; q.options = [];
              for (let i = 1; i < parts.length; i++) {
                const t = parts[i].trim();
                q.options.push({ label: t.charAt(0), text: t.substring(1).replace(/^[\.ï¼ã€]/, "").trim() });
              }
            }
          }
          return q;
        });
      }

      function switchModule(key) {
        if (isExamMode && key !== 'mock_exam') {
            if(!confirm("è€ƒè¯•ä¸­ï¼Œåˆ‡æ¢å°†äº¤å·ï¼Œç¡®å®šï¼Ÿ")) return;
            endExamMode();
        }
        curMod = key; localStorage.setItem("last_mod", key);
        document.querySelectorAll('.mod-tab').forEach(btn => btn.classList.remove('active'));
        
        const map = {'wrong_book':'tab-wrong', 'favorites':'tab-fav', 'random_drill':'tab-random', 'mock_exam':'tab-mock', 'postgrad':'tab-pg', 'history':'tab-hist'};
        if(map[key]) document.getElementById(map[key]).classList.add('active');

        document.getElementById("continueBtn").style.display = "none";
        document.getElementById("examTimerBar").classList.remove("active");
        document.getElementById("normalTopNav").style.display = "flex";
        document.getElementById("toolRow").style.display = "flex";
        document.getElementById("searchBox").value = ""; // æ¸…ç©ºæœç´¢

        if (key === 'wrong_book') loadWrongBook();
        else if (key === 'favorites') loadFavorites();
        else if (key === 'random_drill') loadRandomDrill();
        else if (key === 'mock_exam') {} 
        else {
            allData = modules[key].data; curChapter = ""; rawList = []; filteredList = [];
            initSidebar(); 
            document.getElementById("qContainer").innerHTML = 
                `<div style="text-align:center; margin-top:100px; color:var(--text-sub);">
                   <div style="font-size:2rem;margin-bottom:10px">ğŸ“‚</div>
                   å·²åˆ‡æ¢è‡³ ${modules[key].name}<br>è¯·åœ¨å·¦ä¾§é€‰æ‹©ç« èŠ‚
                 </div>`;
            document.getElementById("headerTitle").innerText = "è¯·é€‰æ‹©ç« èŠ‚";
            document.getElementById("qJumper").disabled = true;
        }
      }

      function loadWrongBook() {
        const pool = [...modules.postgrad.data, ...modules.history.data];
        rawList = pool.filter(q => wrongSet.has(q._uid));
        rawList.forEach(q => { q.isSubmitted = false; q.userSel = new Set(); });
        
        // V17.0ï¼šæ·»åŠ æ¸…ç©ºæŒ‰é’®
        document.getElementById("chapterList").innerHTML = 
            `<div style="padding:15px; color:var(--text-sub); text-align:center">
                <div style="margin-bottom:10px">å…±æ”¶é›†é”™é¢˜ <strong>${rawList.length}</strong> é“</div>
                ${rawList.length > 0 ? `<button onclick="clearWrongBook()" style="color:#ef4444; border:1px solid #ef4444; background:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ğŸ—‘ï¸ ä¸€é”®æ¸…ç©ºé”™é¢˜æœ¬</button>` : ''}
             </div>`;
        curChapter = "é”™é¢˜æœ¬";
        setFilter('all');
        if(rawList.length === 0) showEmptyState("ğŸ‰ å¤ªæ£’äº†ï¼æ²¡æœ‰é”™é¢˜ï¼");
      }
      
      function loadFavorites() {
        const pool = [...modules.postgrad.data, ...modules.history.data];
        rawList = pool.filter(q => favoriteSet.has(q._uid));
        rawList.forEach(q => { q.isSubmitted = false; q.userSel = new Set(); });
        document.getElementById("chapterList").innerHTML = `<div style="padding:15px; text-align:center">å…±æ”¶è— <strong>${rawList.length}</strong> é“</div>`;
        curChapter = "æˆ‘çš„æ”¶è—";
        setFilter('all');
        if(rawList.length === 0) showEmptyState("ğŸ“‚ æš‚æ— æ”¶è—");
      }

      function loadRandomDrill() {
        let pool = [...modules.postgrad.data, ...modules.history.data].filter(q => q.type && q.type.includes("é€‰"));
        for (let i = pool.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [pool[i], pool[j]] = [pool[j], pool[i]]; }
        rawList = pool;
        document.getElementById("chapterList").innerHTML = `<div style="padding:15px; text-align:center">ä¹±åºæ¨¡å¼<br>å…± ${rawList.length} é¢˜</div>`;
        curChapter = "ä¹±åºåˆ·é¢˜";
        rawList.forEach(q => { q.userSel = new Set(); q.isSubmitted = false; });
        setFilter('all');
      }
      
      function showEmptyState(msg) {
          document.getElementById("qContainer").innerHTML = `<div style="text-align:center; margin-top:100px; color:var(--text-sub);">${msg}</div>`;
      }

      window.startMockExam = function() {
          if (isExamMode) return;
          if(!confirm("å¼€å§‹å…¨çœŸæ¨¡æ‹Ÿè€ƒè¯•ï¼Ÿ\n\n1. é™æ—¶45åˆ†é’Ÿ\n2. åŒ…å«å•é€‰/å¤šé€‰/å¤§é¢˜\n3. ä¸­é€”ä¸å¯çœ‹ç­”æ¡ˆ")) return;
          
          isExamMode = true;
          switchModule('mock_exam');
          
          const pool = [...modules.postgrad.data, ...modules.history.data];
          const pick = (arr, n) => {
              const res = []; const idxs = new Set();
              while(res.length < n && idxs.size < arr.length) {
                  const i = Math.floor(Math.random() * arr.length);
                  if(!idxs.has(i)) { idxs.add(i); res.push({...arr[i], userSel:new Set(), isSubmitted:false}); }
              }
              return res;
          };
          
          const l1 = pick(pool.filter(q=>q.type&&q.type.includes("å•é€‰")), 30);
          const l2 = pick(pool.filter(q=>q.type&&q.type.includes("å¤šé€‰")), 10);
          const l3 = pick(pool.filter(q=>!q.type||(!q.type.includes("å•é€‰")&&!q.type.includes("å¤šé€‰")&&q.type!=="çŸ¥è¯†ç‚¹")), 5);
          
          rawList = [...l1, ...l2, ...l3]; filteredList = rawList; curIndex = 0; curChapter = "å…¨çœŸæ¨¡æ‹Ÿè€ƒè¯•";
          
          document.getElementById("chapterList").innerHTML = `<div style="padding:15px; text-align:center">ğŸ“ è€ƒè¯•ä¸­...<br>å…± ${rawList.length} é¢˜</div>`;
          document.getElementById("normalTopNav").style.display = "none";
          document.getElementById("examTimerBar").classList.add("active");
          document.getElementById("toolRow").style.display = "none"; 
          
          examSeconds = 45 * 60;
          updateTimerDisplay();
          examTimer = setInterval(() => {
              examSeconds--; updateTimerDisplay();
              if (examSeconds <= 0) submitMockExam(true);
          }, 1000);
          
          renderQ();
      };
      
      function updateTimerDisplay() {
          const m = Math.floor(examSeconds/60).toString().padStart(2,'0');
          const s = (examSeconds%60).toString().padStart(2,'0');
          const el = document.getElementById("examCountdown");
          el.innerText = `${m}:${s}`;
          if(examSeconds < 300) el.style.color = "#ef4444";
      }
      
      window.submitMockExam = function(force = false) {
          if (!force && !confirm("ç¡®å®šäº¤å·ï¼Ÿ")) return;
          endExamMode();
          let score = 0, total = 0;
          rawList.forEach(q => {
              q.isSubmitted = true;
              if (q.type.includes("å•é€‰")) { total+=2; if(getQuestionStatus(q)==='correct') score+=2; }
              else if (q.type.includes("å¤šé€‰")) { total+=3; if(getQuestionStatus(q)==='correct') score+=3; else if(getQuestionStatus(q)==='partial') score+=1; }
              else total+=5;
          });
          document.getElementById("normalTopNav").style.display = "flex";
          document.getElementById("toolRow").style.display = "flex";
          document.getElementById("examTimerBar").classList.remove("active");
          alert(`è€ƒè¯•ç»“æŸï¼\nå®¢è§‚é¢˜å¾—åˆ†ï¼š${score} / ${total}`);
          setFilter('all');
      };
      
      function endExamMode() { if(examTimer) clearInterval(examTimer); isExamMode = false; }

      function initSidebar() {
        const list = document.getElementById("chapterList"); list.innerHTML = "";
        const map = new Map();
        allData.forEach((q) => { map.set(q.chapter, (map.get(q.chapter)||0)+1); });

        map.forEach((total, cName) => {
            const key = modules[curMod].prefix + cName;
            const saved = JSON.parse(localStorage.getItem(key) || "[]");
            const done = saved.filter((x) => x && x.done).length;
            const pct = total > 0 ? Math.round((done/total)*100) : 0;

            const div = document.createElement("div");
            div.className = "chapter-item";
            if (cName === curChapter) div.classList.add("active");
            
            div.innerHTML = `
                <div class="chap-row-top"><span>${cName}</span><span class="badge-pill">${done}/${total}</span></div>
                <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>`;
            div.onclick = () => loadChapter(cName);
            list.appendChild(div);
        });
      }

      function loadChapter(cName) {
        curChapter = cName; rawList = allData.filter((q) => q.chapter === cName);
        const saved = JSON.parse(localStorage.getItem(modules[curMod].prefix + cName) || "[]");
        rawList.forEach((q, i) => {
          if (saved[i]) { q.userSel = new Set(saved[i].sel || []); q.isSubmitted = saved[i].done || false; } 
          else { q.userSel = new Set(); q.isSubmitted = false; }
        });
        setFilter(filterType); initSidebar(); updateContinueBtn();
        if (window.innerWidth <= 768) {
             document.getElementById("sidebar").classList.remove("open");
             document.getElementById("overlay").classList.remove("active");
        }
      }

      function updateContinueBtn() {
          const u = rawList.filter(q => !q.isSubmitted).length;
          const btn = document.getElementById("continueBtn");
          if(u > 0 && !['wrong_book','random_drill','favorites'].includes(curMod)) {
              btn.style.display = "flex"; document.getElementById("unfinishedCount").innerText = u;
          } else btn.style.display = "none";
      }

      function jumpToUnfinished() {
          const idx = filteredList.findIndex(q => !q.isSubmitted);
          if (idx !== -1) jumpTo(idx); else alert("æœ¬ç« å·²åšå®Œï¼");
      }

      function getQuestionStatus(q) {
          if (!q.isSubmitted) return 'none';
          if (q.type === 'çŸ¥è¯†ç‚¹') return 'correct';
          if (!q.options || q.options.length === 0) return 'correct'; 
          const cSet = new Set((q.answer||"").toUpperCase().split("").filter(c=>/[A-Z]/.test(c)));
          const uSet = q.userSel || new Set();
          for (let s of uSet) if (!cSet.has(s)) return 'wrong';
          if (uSet.size === cSet.size) return 'correct';
          if (uSet.size > 0) return 'partial';
          return 'wrong';
      }

      function setFilter(type) {
        filterType = type;
        document.querySelectorAll(".filter-chip").forEach((b) => {
          b.className = b.innerText.includes(type==="all"?"å…¨éƒ¨":type) ? "filter-chip active" : "filter-chip";
        });
        filteredList = type==="all" ? rawList : rawList.filter((q) => q.type && q.type.includes(type));
        
        const sel = document.getElementById("qJumper"); sel.innerHTML = "";
        if (filteredList.length === 0) {
          sel.disabled = true; document.getElementById("qContainer").innerHTML = `<div style="text-align:center;margin-top:50px;">æš‚æ— é¢˜ç›®</div>`; return;
        }
        sel.disabled = false;
        filteredList.forEach((q, i) => {
          const s = getQuestionStatus(q);
          const mk = s==='correct'?" âœ…":s==='partial'?" ğŸŒ—":s==='wrong'?" âŒ":"";
          sel.add(new Option(`${i + 1}. ${shorten(q.content)}${mk}`, i));
        });
        if(curIndex >= filteredList.length) curIndex = 0;
        renderQ();
      }

      function shorten(s) { return s.length > 8 ? s.substring(0, 8) + "..." : s; }

      // === æ ¸å¿ƒæ¸²æŸ“ (V17.0 å‡çº§ç‰ˆ) ===
      function renderQ() {
        if (!filteredList.length) return;
        const q = filteredList[curIndex];

        if (isExamMode) document.getElementById("headerTitle").innerText = `æ¨¡æ‹Ÿè€ƒ: ${curIndex + 1} / ${filteredList.length}`;
        else {
            document.getElementById("headerTitle").innerText = curChapter;
            document.getElementById("qJumper").value = curIndex;
        }
        
        if (!(q.userSel instanceof Set)) q.userSel = new Set(q.userSel || []);
        userSel = new Set(q.userSel);

        const container = document.getElementById("qContainer");
        let cardClass = "card"; 
        if (curMod === 'wrong_book') cardClass += " wrong-mode";
        else if (curMod === 'favorites') cardClass += " fav-mode";
        else if (q.type === "çŸ¥è¯†ç‚¹") cardClass += " knowledge-mode";

        // æŒ‰é’®æ–‡å­—é€»è¾‘
        const mBtn = document.getElementById("mainBtn");
        let btnTxt = "âœ… æäº¤ç­”æ¡ˆ", btnCls = "btn btn-primary";
        if(isExamMode) {
            btnTxt = curIndex < filteredList.length - 1 ? "ä¸‹ä¸€é¢˜ â¡ï¸" : "å®Œæˆ (ç‚¹å‡»é¡¶éƒ¨äº¤å·)";
            btnCls = curIndex === filteredList.length - 1 ? "btn btn-exam-submit" : "btn btn-secondary";
            mBtn.onclick = () => move(1);
        } else {
             if(q.isSubmitted && q.type !== "çŸ¥è¯†ç‚¹") btnTxt = curIndex < filteredList.length - 1 ? "ä¸‹ä¸€é¢˜ â¡ï¸" : "å®Œæˆæœ¬ç« ";
             mBtn.onclick = handleMainAction;
        }
        mBtn.innerText = btnTxt; mBtn.className = btnCls;

        // V17.0: å¤„ç†é«˜äº®å†…å®¹
        const displayContent = highlightContent(q.content);

        // é€‰é¡¹æ¸²æŸ“
        let bodyHtml = "";
        if (q.type === "çŸ¥è¯†ç‚¹") {
          bodyHtml = `<div style="font-size:1.1em; line-height:1.8; font-weight:500">${displayContent}</div>`;
        } else if (q.options && q.options.length > 0) {
          // V17.1: æ™®é€šæ¨¡å¼ä¸‹å»æ‰é—ªå¡æ¨¡ç³Šï¼Œå› ä¸ºå·²ç»æœ‰äº†ç‹¬ç«‹æ²‰æµ¸æ¨¡å¼
          const optsHtml = q.options.map((opt) => {
              let cls = "opt-row";
              const cSet = new Set((q.answer||"").toUpperCase().split(""));
              if (isExamMode) { if (userSel.has(opt.label)) cls += " selected"; }
              else if (q.isSubmitted) {
                if (cSet.has(opt.label)) { cls += " correct"; if (!userSel.has(opt.label)) cls += " missed"; }
                else if (userSel.has(opt.label)) cls += " wrong";
              } else if (userSel.has(opt.label)) cls += " selected";
              
              return `
             <div class="${cls}" onclick="handleOpt('${opt.label}')">
               <div class="opt-idx">${opt.label}</div>
               <div style="flex:1">${opt.text}</div>
             </div>`;
          }).join("");
          bodyHtml = `<div class="opts-container">${optsHtml}</div>`;
        } else {
          bodyHtml = `<div style="padding:15px; background:var(--bg-body); color:var(--text-sub); font-style:italic">(è¯·åœ¨å¿ƒä¸­ä½œç­”)</div>`;
        }
        
        const isFav = favoriteSet.has(q._uid);
        const starHtml = `<span class="star-icon ${isFav ? 'active' : ''}" onclick="toggleFav('${q._uid}')">${isFav ? 'â­' : 'â˜†'}</span>`;
        const showAi = !isExamMode && q.isSubmitted && q.type !== "çŸ¥è¯†ç‚¹";

        // V17.0: å¢åŠ çŠ¶æ€Badge
        let statusBadge = "";
        if(!isExamMode && q.isSubmitted && q.type.includes("é€‰")) {
            const st = getQuestionStatus(q);
            if(st==="wrong") statusBadge = `<div class="status-badge status-wrong">âŒ å›ç­”é”™è¯¯</div>`;
            else if(st==="partial") statusBadge = `<div class="status-badge status-partial">âš ï¸ æ¼é€‰</div>`;
            else statusBadge = `<div class="status-badge status-correct">âœ… æ­£ç¡®</div>`;
        }

        container.innerHTML = `
          <div class="${cardClass}">
             <div class="q-header">
                <div><span class="q-type">${q.type||"é¢˜ç›®"}</span>${starHtml}</div>
                <span style="font-size:0.8em; color:var(--text-sub)">${curIndex + 1} / ${filteredList.length}</span>
             </div>
             ${q.type!=="çŸ¥è¯†ç‚¹"?`<div class="q-content">${displayContent}</div>`:""}
             ${bodyHtml}
             
             <div class="answer-section ${(!isExamMode && q.isSubmitted) ? "show" : ""}" id="ansPanel">
                ${statusBadge}
                <div style="margin-bottom:10px;">
                   <strong>å‚è€ƒç­”æ¡ˆï¼š</strong><span style="color:var(--primary); font-weight:bold; font-size:1.1em">${q.answer||"ç•¥"}</span>
                </div>
                <div style="font-size:0.95em; border-top:1px solid var(--border-color); padding-top:10px; line-height:1.6">
                   <strong>è§£æï¼š</strong><br>${highlightContent(q.explanation)||"æš‚æ— "}
                </div>
                
                ${curMod==='wrong_book' ? `<button class="btn btn-secondary" style="margin-top:15px; width:100%; border-color:#fca5a5; color:#dc2626; background:#fef2f2" onclick="removeFromWrongBook('${q._uid}')">ğŸ—‘ï¸ ç§»å‡ºé”™é¢˜æœ¬</button>` : ''}

                ${showAi ? `
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:15px;">
                  <button class="btn btn-primary" style="flex:1;" onclick="askAI()">ğŸ¤– AI æ·±åº¦è§£æ</button>
                  <button class="btn btn-secondary" style="flex:1" onclick="copyPrompt()">ğŸ“‹ å¤åˆ¶é¢˜ç›®</button>
                </div>
                <div id="aiResult" class="ai-result"></div>` : ''}
             </div>
          </div>
        `;
      }

      window.toggleFav = function(uid) {
          if (favoriteSet.has(uid)) favoriteSet.delete(uid); else favoriteSet.add(uid);
          localStorage.setItem("favorite_questions", JSON.stringify(Array.from(favoriteSet)));
          updateCounts(); renderQ();
      };

      window.handleOpt = function (label) {
        const q = filteredList[curIndex];
        if (!isExamMode && q.isSubmitted) return;
        if (isExamMode || (q.type && q.type.includes("å¤š")) || (q.answer && q.answer.length > 1)) {
          if (userSel.has(label)) userSel.delete(label); else userSel.add(label);
        } else { userSel.clear(); userSel.add(label); }
        q.userSel = new Set(userSel);
        renderQ();
      };

      window.handleMainAction = function () {
        const q = filteredList[curIndex];
        if (q.isSubmitted) { move(1); return; }
        
        q.isSubmitted = true;
        if (q.type && q.type.includes("é€‰")) {
            const st = getQuestionStatus(q);
            if ((st === 'wrong' || st === 'partial') && !wrongSet.has(q._uid)) {
                wrongSet.add(q._uid);
                localStorage.setItem("wrong_questions", JSON.stringify(Array.from(wrongSet)));
                updateCounts();
            }
        }
        if(!['random_drill','wrong_book','favorites','mock_exam'].includes(curMod)) {
            saveProgress(); initSidebar(); updateContinueBtn();
        }
        renderQ();
      };

      window.removeFromWrongBook = function(uid) {
          if(confirm("å·²æŒæ¡ï¼Ÿç§»å‡ºï¼Ÿ")) {
              wrongSet.delete(uid); localStorage.setItem("wrong_questions", JSON.stringify(Array.from(wrongSet)));
              updateCounts(); loadWrongBook(); 
          }
      };

      window.move = function (dir) {
        const n = curIndex + dir;
        if (n >= 0 && n < filteredList.length) { curIndex = n; renderQ(); }
        else if (dir === 1) alert("æœ¬åˆ—è¡¨å·²ç»“æŸ");
      };

      window.jumpTo = function (v) { curIndex = parseInt(v); renderQ(); };
      window.toggleAns = function () { document.getElementById("ansPanel").classList.toggle("show"); };

      window.resetChapter = function () {
        if (!confirm(`æ¸…ç©ºè¿›åº¦ï¼Ÿ`)) return;
        rawList.forEach((q) => { q.isSubmitted = false; q.userSel = new Set(); });
        if(!['random_drill','wrong_book','favorites','mock_exam'].includes(curMod)) {
            saveProgress(); loadChapter(curChapter);
        } else renderQ();
      };

      function saveProgress() {
        const s = rawList.map(q => ({ sel: Array.from(q.userSel), done: q.isSubmitted }));
        localStorage.setItem(modules[curMod].prefix + curChapter, JSON.stringify(s));
      }

      window.toggleSidebar = function () {
        document.getElementById("sidebar").classList.toggle("open");
        document.getElementById("overlay").classList.toggle("active");
      };

      function initDarkMode() {
          if(localStorage.getItem("dark_mode") === "true") document.body.classList.add("dark-mode");
          updateDarkModeBtnText();
      }
      window.toggleDarkMode = function() {
          document.body.classList.toggle("dark-mode");
          localStorage.setItem("dark_mode", document.body.classList.contains("dark-mode"));
          updateDarkModeBtnText();
      }
      function updateDarkModeBtnText() {
          document.getElementById("darkModeBtn").innerText = document.body.classList.contains("dark-mode") ? "â˜€ï¸ æ—¥é—´æ¨¡å¼" : "ğŸŒ™ å¤œé—´æ¨¡å¼";
      }

      window.exportData = function() {
          const blob = new Blob([JSON.stringify({timestamp:new Date(), store:{...localStorage}})], {type:"application/json"});
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
          a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
      }
      window.importData = function() { document.getElementById("fileInput").click(); }
      window.handleFileImport = function(input) {
          const f = input.files[0]; if(!f)return;
          const r = new FileReader();
          r.onload = e => {
              try {
                  const d = JSON.parse(e.target.result);
                  if(d.store && confirm(`æ¢å¤ ${d.timestamp} çš„å¤‡ä»½ï¼Ÿ`)) {
                      localStorage.clear(); Object.keys(d.store).forEach(k=>localStorage.setItem(k, d.store[k]));
                      location.reload();
                  }
              } catch(e){alert("æ–‡ä»¶æ— æ•ˆ");}
          }; r.readAsText(f); input.value="";
      }

      // AI Logic
      window.openAiSettings = function() { document.getElementById("overlay").style.display="block"; document.getElementById("aiModal").style.display="block"; toggleAiInputs(); }
      window.toggleAiInputs = function() {
          ['geminiConfig','qwenConfig','siliconFlowConfig','customConfig'].forEach(id=>document.getElementById(id).style.display='none');
          const t = document.getElementById("aiProvider").value;
          if(t==='gemini') document.getElementById('geminiConfig').style.display='block';
          else if(t==='qwen') document.getElementById('qwenConfig').style.display='block';
          else if(t==='siliconflow') document.getElementById('siliconFlowConfig').style.display='block';
          else document.getElementById('customConfig').style.display='block';
      }
      window.closeAll = function() {
          document.getElementById("overlay").style.display="none"; document.getElementById("aiModal").style.display="none";
          document.getElementById("sidebar").classList.remove("open"); document.getElementById("overlay").classList.remove("active");
      }
      window.saveAiSettings = function() {
          localStorage.setItem("ai_provider", document.getElementById("aiProvider").value);
          localStorage.setItem("ai_gemini_key", document.getElementById("geminiKey").value);
          localStorage.setItem("ai_qwen_key", document.getElementById("qwenKey").value);
          localStorage.setItem("ai_sf_key", document.getElementById("sfKey").value);
          localStorage.setItem("ai_custom_url", document.getElementById("customUrl").value);
          localStorage.setItem("ai_custom_key", document.getElementById("customKey").value);
          closeAll();
      }
      window.askAI = async function() {
        const resDiv = document.getElementById("aiResult"); resDiv.style.display="block"; resDiv.innerHTML="ğŸ¤– æ€è€ƒä¸­...";
        const q = filteredList[curIndex];
        const prompt = `è§£æå†å²é¢˜ï¼š${q.content}\né€‰é¡¹ï¼š${JSON.stringify(q.options)}\nç­”æ¡ˆï¼š${q.answer}\nè¯·è§£é‡ŠåŸå› åŠé”™è¯¯é€‰é¡¹åˆ†æã€‚`;
        const prov = localStorage.getItem("ai_provider")||"gemini";
        try {
            let txt = "";
            if (prov === 'gemini') {
                 const key = localStorage.getItem("ai_gemini_key");
                 const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, 
                 {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})});
                 const d = await r.json(); txt = d.candidates?.[0]?.content?.parts?.[0]?.text;
            } else if (prov === 'siliconflow') {
                 const key = localStorage.getItem("ai_sf_key");
                 const r = await fetch("https://api.siliconflow.cn/v1/chat/completions",
                 {method:"POST",headers:{"Authorization":`Bearer ${key}`,"Content-Type":"application/json"},body:JSON.stringify({model:"Qwen/Qwen2.5-72B-Instruct",messages:[{role:"user",content:prompt}]})});
                 const d = await r.json(); txt = d.choices?.[0]?.message?.content;
            } else if (prov === 'qwen') {
                 const key = localStorage.getItem("ai_qwen_key")||BUILTIN_API_KEY;
                 const r = await fetch("https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions",
                 {method:"POST",headers:{"Authorization":`Bearer ${key}`,"Content-Type":"application/json"},body:JSON.stringify({model:"qwen-turbo",messages:[{role:"user",content:prompt}]})});
                 const d = await r.json(); txt = d.choices?.[0]?.message?.content;
            } else {
                 const url = localStorage.getItem("ai_custom_url") + "/chat/completions";
                 const key = localStorage.getItem("ai_custom_key");
                 const r = await fetch(url, {method:"POST",headers:{"Authorization":`Bearer ${key}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"user",content:prompt}]})});
                 const d = await r.json(); txt = d.choices?.[0]?.message?.content;
            }
            resDiv.innerHTML = (txt||"Error").replace(/\n/g,"<br>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>");
        } catch(e) { resDiv.innerHTML = "Request Failed: "+e.message; }
      }
      window.copyPrompt = function() {
          const q = filteredList[curIndex];
          navigator.clipboard.writeText(`é¢˜ç›®ï¼š${q.content}\né€‰é¡¹ï¼š${JSON.stringify(q.options)}\nç­”æ¡ˆï¼š${q.answer}`).then(()=>alert("å¤åˆ¶æˆåŠŸ"));
      }
    </script>
  </body>
</html>